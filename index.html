<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey</title>
	<link rel="apple-touch-icon" sizes="180x180" href="/faviconimg/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/faviconimg/favicon-16x16.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/faviconimg/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="48x48" href="/faviconimg/favicon-48x48.png">
	<link rel="icon" type="image/png" sizes="96x96" href="/faviconimg/favicon-96x96.png">
	<link rel="icon" type="image/png" sizes="192x192" href="/faviconimg/favicon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/faviconimg/favicon-512x512.png">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@300;700&display=swap');
        :root {
            --primary-color: #ffffff;
            --secondary-color: #333333;
            --accent-color: #ff6600;
            --selection-blue: #007bff;
            --font-stack: 'Montserrat', sans-serif;
            --title-font-stack: 'Poppins', sans-serif;
        }
        html {
            font-size: 1.33vw;
            font-size: clamp(12px, 1.33vw, 16px);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: var(--font-stack);
            background-color: var(--primary-color);
            color: var(--secondary-color);
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        .main-header {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            transition: opacity 0.5s ease;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .logo-text {
           display: none;
        }
        .logo-icon {
            width: 80px;
            height: auto;
            border-radius: 0;
        }
        .background-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            background-image: url('https://t3.ftcdn.net/jpg/06/48/43/62/360_F_648436265_aTw8qng7ViOMKkUBm1Pkvz5xaST4W2W1.jpg');
            background-size: cover;
            background-position: center;
            animation: fadeIn 2s ease-out;
        }
        .background-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--overlay-color);
            z-index: 0;
        }
        .container {
            width: 90%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: relative;
            z-index: 10;
            animation: slideIn 0.8s ease-out;
        }
        .welcome-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            margin-top: -5rem;
        }
        .welcome-logo-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        .welcome-logo-icon {
            width: 300px;
            margin-bottom: 0;
        }
        .welcome-logo-title {
            font-family: var(--title-font-stack);
            font-size: 1.8rem;
            font-weight: 300;
            color: var(--welcome-logo-title-color);
            letter-spacing: 2px;
            text-transform: uppercase;
            position: absolute;
            top: 62%;
            left: 67%;
            transform: translateX(-50%);
        }
        .welcome-text {
            font-size: 1.5rem;
            max-width: 600px;
            margin-bottom: 1rem;
            color: var(--welcome-text-color);
        }
        .form-row {
            display: flex;
            gap: 15px;
            width: 100%;
            align-items: flex-end;
}
        .form-row .input-group {
            margin-bottom: 0;
}
        .name-group {
            flex: 4;
}
        .age-group {
            flex: 1;
}         
        .survey-form {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            width: 100%;
            max-width: 400px;
        }
        .input-group {
            width: 100%;
        }
        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            text-align: center;
        }
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #fff;
            color: #333;
        }
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }
        .proceed-btn, .anonymous-btn, .next-btn, .submit-btn, .final-button, .skip-btn {
            background-color: var(--accent-color);
            color: #fff;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 100%;
            text-decoration: none;
            text-align: center;
        }
        .anonymous-btn {
            background-color: transparent;
            border: 2px solid var(--accent-color);
            color: var(--accent-color);
        }
        .proceed-btn:hover, .anonymous-btn:hover, .next-btn:hover, .skip-btn:hover {
            background-color: var(--accent-hover-color);
            color: #fff;
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .question-card {
            background: var(--question-card-bg);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 550px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
	        align-items: center;
        }
        .survey-title {
            font-size: 1.2rem;
	    color: var(--question-title-color);
        }
        .question-options {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .question-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            color: var(--question-option-text-color);
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            border: 2px solid transparent;
            font-size: 0.9rem;
        }
        .question-option:hover {
            background-color: #fff;
            border-color: var(--selection-blue);
        }
        .question-option.selected {
            border: 2px solid var(--selection-blue);
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
        }
        .other-input-inline {
            flex-grow: 1;
            border: none;
            background: transparent;
            border-bottom: 1px solid #999;
            padding: 2px;
            font-family: inherit;
            font-size: inherit;
            color: inherit;
            outline: none;
            width: auto;
        }
	    .textarea-input {
    	    width: 100%;
            height: 60px;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
        }
        .navigation-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            max-width: 280px;
            align-items: center;
            margin-top: 0.5rem;
        }
        .back-text {
            color: var(--back-text-color);
            text-decoration: none;
            font-weight: 300;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .back-text:hover {
            color: var(--accent-color);
        }
        .final-page {
            text-align: center;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.9), rgba(245, 245, 245, 0.8));
            padding: 2rem 1.5rem;
            border-radius: 15px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 550px;
        }
        .final-page h2 {
            font-size: 2.2rem;
            margin-bottom: 1rem;
            color: var(--accent-color);
            word-break: break-word;
        }
        .final-page p {
            font-size: 1.1rem;
            color: #444;
        }
        .suggested-surveys {
            margin-top: 2rem;
            width: 100%;
        }
        .suggested-surveys h3 {
            margin-bottom: 1rem;
            font-size: 1.3rem;
	    color: var(--final-page-subtitle-color);
        }
        .survey-links-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 30px;
            max-height: 220px;
            overflow-y: auto;
            align-items: center;
        }
        .survey-link {
    background-color: var(--suggested-link-bg);
    color: #ffffff;
    padding: 15px 20px;
    font-size: 1rem;
    font-weight: bold;
    border-radius: 10px;
    text-decoration: none;
    transition: all 0.3s ease;
    border: none;
    box-shadow: 0 4px 15px rgba(0, 95, 126, 0.3);
    text-align: center;
    width: 90%;
    max-width: 350px;
}
	.dark-button-text-theme .anonymous-btn:hover {
    	color: #333;
    }
        .survey-link:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 6px 20px rgba(0, 95, 126, 0.4);
            background: var(--suggested-link-hover-bg);
        }
        .final-button {
            margin-top: 1rem;
            max-width: 300px;
            align-self: center;
        }

        .spinner-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(14, 42, 71, 0.7);
    backdrop-filter: blur(5px);
    z-index: 3000;
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
}

.spinner-overlay.visible {
    opacity: 1;
}

.custom-spinner {
    width: 60px;
    height: 60px;
    border: 6px solid rgba(255, 255, 255, 0.3);
    border-top-color: #ffffff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

	.alert-modal p {
    	    color: #333;
    }
	.eb-theme-layout .welcome-section {
            margin-top: -15rem;
    }
	.eb-theme-layout .welcome-logo-title {
	    top: 83%;
            left: 50%;
    }
	.eb-theme-layout .welcome-logo-icon {
    	    transform: translateY(65px);
    }
	.eb-theme-layout .survey-form {
    	    margin-top: 0px;
    }
	.eb-theme-layout .welcome-text {
   	    font-size: 1.50rem;
    }
	.smj-theme-layout .welcome-logo-title {
            top: 75%;
            left: 50%;
    }
	.smj-theme-layout .survey-form {
    	    margin-top: 0px;
    }
	.smj-theme-layout .welcome-section {
    	    margin-top: -2rem;	
    }
	.smj-theme-layout .welcome-logo-icon {
    	    transform: translateY(-40px);
    }
	.smj-theme-layout .question-option:hover {
 	    border-color: #d93025;
    }
	.smj-theme-layout .question-option.selected {
    	    border-color: #d93025;
    	    box-shadow: 0 0 10px rgba(217, 48, 37, 0.5);
    }
    .alert-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #fff;
    color: var(--secondary-color);
    padding: 20px 30px;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    z-index: 3100;
    text-align: center;
    animation: popIn 0.3s ease-out;
    border: 1px solid #ccc;
}
        .alert-modal button {
            background-color: var(--accent-color);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes popIn { from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
	    @keyframes loading-dots {
    	    0% {
            content: '.';
        }
    	    33% {
            content: '..';
        }
    	    66%, 100% {
            content: '...';
        }
    }
	   .loading-animation::after {
 	    content: '';
     	    display: inline-block;
    	    width: 20px;
   	    text-align: left;
    	    animation: loading-dots 1.5s infinite;
    }
	@keyframes slide-in-question {
        from {
            opacity: 0;
            transform: translateX(30px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
	@keyframes slide-out-question {
        from {
            opacity: 1;
            transform: translateX(0);
        }
        to {
            opacity: 0;
            transform: translateX(-30px);
        }
    }
	.slide-in-question {
        animation: slide-in-question 0.4s ease-out;
    }
	.slide-out-question {
        animation: slide-out-question 0.4s ease-out forwards;
    }
        @media (max-width: 767px) {
            .main-header {
                top: 15px;
                left: 15px;
            }
            .logo-icon {
                width: 80px;
                border-radius: 0;
            }
            .welcome-logo-icon {
                width: 220px;
            }
            .welcome-logo-title {
                font-size: 1.5rem;
                top: 60%;
                left: 58%;
            }
            .welcome-text {
                font-size: 1.3rem;
                margin-bottom: 1rem;
            }
            .question-card, .final-page {
                padding: 1.5rem;
            }
            .final-page {
                max-width: 90vw;
                padding: 1.5rem 1rem;
            }
            
            .survey-title {
                font-size: 1.2rem;
            }
            
            .final-page h2 {
                font-size: 1.8rem;
            }
            .welcome-section {
                gap: 2rem;
                justify-content: flex-start;
                padding-top: 0;
                margin-top: -6rem;
            }
	        .light-accent-theme .proceed-btn,
	        .light-accent-theme .next-btn,
	        .light-accent-theme .submit-btn,
            .light-accent-theme .final-button,
            .light-accent-theme .skip-btn {
                color: #333;
            }
	        .light-accent-theme .proceed-btn:hover,
            .light-accent-theme .next-btn:hover,
	        .light-accent-theme .skip-btn:hover {
    		    color: #333;
            }
 	        .light-accent-theme .anonymous-btn {
   	            background-color: transparent;
    	        border-color: #fff;
    	        color: #fff;
            }
	        .light-accent-theme .anonymous-btn:hover {
    	        background-color: #fff;
    	        color: #333;
            }
	        .smj-theme-layout .welcome-logo-title {
    	        top: 68%;   
    	        left: 50%;
            }
	        .eb-theme-layout .welcome-logo-title {
    	        top: 92%;   
    	        left: 50%;
            }
	        .eb-theme-layout .welcome-text {
    		    font-size: 1.3rem !important; 
            }
        }
        #admin-panel-container {
            font-family: 'Poppins', sans-serif;
            width: 100%;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        #admin-panel-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://t3.ftcdn.net/jpg/06/48/43/62/360_F_648436265_aTw8qng7ViOMKkUBm1Pkvz5xaST4W2W1.jpg');
            background-size: cover;
            background-position: center;
            filter: blur(4px);
            z-index: -2;
        }
        #admin-panel-container::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(14, 42, 71, 0.85);
            z-index: -1;
        }

        .admin-panel-title {
    position: absolute;
    top: 45px;
    left: 45px;
    color: #fff;
    font-size: 1.8rem;
    font-family: 'Poppins', sans-serif;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 15px;
}
        .admin-main-menu {
            display: flex;
            gap: 40px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }
        .admin-card {
    background: rgba(0, 123, 255, 0.2);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 20px;
    width: 250px;
    height: 250px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    border: 1px solid rgba(0, 123, 255, 0.5);
    color: #fff;
    box-shadow: 0 0 20px rgba(0, 123, 255, 0.5);
}

.admin-card:hover {
    transform: translateY(-10px) scale(1.05);
    background: rgba(0, 123, 255, 0.3);
    box-shadow: 0 0 30px rgba(0, 123, 255, 0.8);
}

.admin-card svg {
    width: 80px;
    height: 80px;
    fill: #fff;
}

.admin-card h2 {
    font-family: 'Poppins', sans-serif;
    font-size: 1.5rem;
    color: #fff;
}
.admin-page-content:has(.stats-dashboard) {
    max-width: 1200px;
    height: 92vh;
}
.admin-page-content {
    background: rgba(0, 80, 150, 0.25);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(0, 123, 255, 0.3);
    padding: 25px 40px;
    border-radius: 15px;
    width: 95%;
    max-width: 1200px;
    height: 88vh;
    color: #fff;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    position: relative;
    display: flex;
    flex-direction: column;
}

.admin-page-content h1 {
    font-family: 'Poppins', sans-serif;
    font-weight: 700;
    color: #fff;
    text-align: center;
    margin-bottom: 20px;
    font-size: 2.1rem;
    flex-shrink: 0;
}
        .admin-back-button {
           background: none;
            border: none;
            font-size: 0.9rem;
            cursor: pointer;
            color: #ccc;
            position: absolute;
            top: 23px;
            left: 20px;
            transition: color 0.2s ease;
            text-decoration: none;
            z-index: 2001;
}
        .admin-back-button:hover {
	    color: #ccc;
}
        .admin-form-group {
            margin-bottom: 25px;
        }
        .admin-form-group label {
            display: block;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        .admin-input, .admin-select {
            width: 94%;
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Montserrat', sans-serif;
            transition: all 0.3s ease;
            background: transparent;
            color: #fff;
        }
        .admin-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1em;
            padding-right: 2.5rem;
        }
        .admin-select option {
    background: white;
    color: black;
}

        .admin-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .admin-input:focus, .admin-select:focus {
            outline: none;
            border-color: #fff;
            background: rgba(255, 255, 255, 0.1);
        }
        .admin-question-block {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 20px;
            flex-grow: 1;
        }
        #admin-panel-container ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
}
        #admin-panel-container ::-webkit-scrollbar-track {
            background: transparent;
}
        #admin-panel-container ::-webkit-scrollbar-thumb {
            background-color: rgba(0, 123, 255, 0.5);
            border-radius: 10px;
            border: 2px solid rgba(0, 0, 0, 0.2);
}
        #admin-panel-container ::-webkit-scrollbar-thumb:hover {
            background-color: rgba(0, 123, 255, 0.7);
}
        .question-block-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .delete-question-btn-wrapper {
            display: flex;
            align-items: center;
            padding-left: 15px;
            cursor: pointer;
            color: #ccc;
            transition: all 0.2s ease-in-out;
            flex-shrink: 0;
        }
        .delete-question-btn-wrapper:hover {
            color: #ff4d4d;
            transform: scale(1.1);
        }
        .question-answers .admin-input {
            padding: 8px 12px;
            font-size: 0.95rem;
        }
        .add-question-btn-main {
            background: none;
            border: 1px dashed rgba(255, 255, 255, 0.5);
            color: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
        }
        .add-question-btn-main:hover {
            background: rgba(255, 255, 255, 0.1);
            border-style: solid;
        }
        .admin-answer-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }
        .admin-answer-group .answer-textfield-select {
    width: 120px !important;
    flex-shrink: 0;
}

        .toggle-answers-btn {
    cursor: pointer;
    padding: 5px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.3s ease, background-color 0.2s;
}
.toggle-answers-btn:hover {
    background-color: rgba(255, 255, 255, 0.1);
}
.toggle-answers-btn.collapsed svg {
    transform: rotate(-90deg);
}
.question-answers.collapsed,
.paragraph-answer-container.collapsed,
.rating-preview-container.collapsed {
    max-height: 0;
    margin-top: 0;
    padding-top: 0;
    padding-bottom: 0;
    border-width: 0;
    opacity: 0;
}
.question-answers,
.paragraph-answer-container,
.rating-preview-container {
    transition: all 0.5s ease-in-out;
    max-height: 1000px;
}

.question-answers {
    padding-left: 25px;
    border-left: 3px solid #007bff;
}
        
        .admin-button {
	    background: #007bff;
	    color: #fff;
	    border: none;
	    padding: 15px 35px;
	    font-size: 1.1rem;
	    font-weight: bold;
	    border-radius: 10px;
	    cursor: pointer;
	    transition: all 0.3s ease;
	    display: inline-flex;
	    align-items: center;
	    justify-content: center;
	    gap: 10px;
	    text-transform: uppercase;
	    letter-spacing: 1px;
	    box-shadow: 0 4px 15px rgba(0,123,255,0.3);
}
        .admin-button:hover {
	    background: #0069d9;
	    box-shadow: 0 7px 20px rgba(0,123,255,0.4);
}
        .admin-button.save-btn {
            background-image: linear-gradient(to right, #28a745 0%, #218838 100%);
            box-shadow: 0 4px 15px rgba(40,167,69,0.3);
        }
        .admin-button.save-btn:hover {
            box-shadow: 0 7px 20px rgba(40,167,69,0.4);
        }
        .admin-delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #fff;
            transition: all 0.3s ease;
            position: absolute;
            top: 20px;
            right: 20px;
        }
        .admin-delete-btn:hover {
            color: #ff4d4d;
            transform: scale(1.1);
        }
        .question-header {
	    display: flex;
	    gap: 5px;
	    justify-content: space-between;
	    align-items: center;
	    margin-bottom: 20px;
}
        .question-header .admin-form-group {
            flex-grow: 1;
            margin-bottom: 0;
        }
        .question-answers {
            padding-left: 25px;
            border-left: 3px solid #007bff;
        }
        .admin-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }
        .admin-list-item {
            background: transparent;
            padding: 8px 10px;
            margin-bottom: 0;
            display: grid;
            grid-template-columns: 1fr 180px 100px;
            align-items: center;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid rgba(0, 123, 255, 0.3);
            border-radius: 0;
        }
        .admin-list-item:hover {
            background-color: rgba(0, 123, 255, 0.1);
            transform: none;
            border-left: none;
        }
        .admin-list-item-info .name {
            font-weight: normal;
            font-size: 1.05rem;
            color: #ffffff;
        }
        .admin-list-item-info .date {
            font-size: 0.85rem;
            color: #6c757d;
        }
        .admin-list-item-actions button {
            background: transparent;
            border: none;
            cursor: pointer;
            margin-left: 15px;
            font-size: 1.5rem;
            transition: transform 0.2s ease;
        }
        .admin-list-item-actions button:hover {
            transform: scale(1.2);
        }
        .admin-list-item-actions .edit-btn { color: #007bff; }
        .admin-list-item-actions .delete-btn { color: #dc3545; }
        .admin-list-item-actions .stats-btn { color: #28a745; }

        .admin-search-bar {
            width: 100%;
            padding: 12px 20px;
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
        }
        .admin-search-bar::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        .admin-list-header {
            display: grid;
            grid-template-columns: 1fr 180px 100px;
            padding: 0 10px 10px 10px;
            border-bottom: 2px solid rgba(0, 123, 255, 0.5);
            font-weight: bold;
            color: #fff;
        }
        .admin-list-item-date {
            font-size: 0.9rem;
            color: #ccc;
            text-align: left;
        }
        .admin-list-item-actions {
            justify-self: end;
        }
        .admin-form-footer {
    position: absolute;
    bottom: 25px;
    left: 50%;
    transform: translateX(-50%);
}

        #summary-view-all {
            max-width: 280px;
}
        #summary-view-all .stats-summary-grid {
           grid-template-columns: 1fr;
           gap: 15px;
}
#survey-form-admin {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    min-height: 0;
}

#questions-container {
    flex-grow: 1;
    overflow-y: auto;
    min-height: 0;
    padding: 10px 10px 80px 10px;
    margin: 0 -10px;
}
        .stats-dashboard {
    display: flex;
    flex-direction: column;
    gap: 15px;
    flex-grow: 1;
    min-height: 0;
}
.stats-filters {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 20px;
    margin-bottom: 0px;
    align-items: end;
}
.stats-filter-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
    flex-grow: 1;
}
.stats-filter-group label {
    font-size: 0.9rem;
    font-weight: bold;
    color: #ccc;
}
.stats-summary-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

.stats-view-switcher {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    border-bottom: 1px solid rgba(0, 123, 255, 0.3);
}
.stats-view-switcher button {
    background: none;
    border: none;
    color: #ccc;
    padding: 10px 20px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: bold;
    border-bottom: 3px solid transparent;
    transition: all 0.2s ease;
}
.stats-view-switcher button:hover {
    color: #fff;
}
.stats-view-switcher button.active {
    color: #fff;
    border-bottom-color: #007bff;
}
.stats-dashboard {
    display: flex;
    flex-direction: column;
    gap: 15px;
    flex-grow: 1;
    min-height: 0;
}

#stats-view-container {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    min-height: 0;
}

#stats-content-area {
    flex-grow: 1;
    min-height: 0;
}

.stats-overall-layout {
    display: grid;
    grid-template-columns: 1fr 520px;
    gap: 25px;
    flex-grow: 1;
    min-height: 0;
    margin-top: 0;
}

.stats-question-view {
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
}

.stats-answers-container {
    overflow-y: auto;
    flex-grow: 1;
    padding-right: 10px;
}
.stats-right-column {
    display: flex;
    flex-direction: column;
    gap: 25px;
    justify-content: stretch;
    min-height: 0;
}
.stats-timeline-chart-container {
    background: rgba(0, 0, 0, 0.2);
    padding: 20px;
    border-radius: 12px;
    width: 100%;
    height: 570px;
    display: flex;
    flex-direction: column;
    position: relative;
}
.stats-summary-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    width: 100%;
}

.date-range-filter {
            display: flex;
            gap: 5px;
            align-items: center;
        }
.admin-date-input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: 'Montserrat', sans-serif;
            background: transparent;
            color: #fff;
            color-scheme: dark;
        }        
.summary-card {
    background: rgba(0, 80, 150, 0.3); /* cite: 1 */
    padding: 20px; /* cite: 1 */
    border-radius: 12px; /* cite: 1 */
    border: 1px solid rgba(0, 123, 255, 0.4); /* cite: 1 */
    height: 90px; 
    text-align: center; 
}
.summary-card-title {
    font-size: 1rem; /* cite: 1 */
    color: #ccc; /* cite: 1 */
    margin-bottom: 0px; 
}
.summary-card-value {
    font-size: 1.4rem;
    font-weight: bold;
    color: #fff;
}
.stats-chart-container {
    background: rgba(0, 0, 0, 0.2);
    padding: 20px;
    border-radius: 12px;
    margin-top: 40px;
    height: 320px;
}
.stats-chart-title {
    font-size: 0.8rem;
    font-weight: bold;
    margin-bottom: 20px;
    color: #fff;
}
.stats-question-view {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
}
.stats-question-card {
    background: rgba(0, 0, 0, 0.2);
    padding: 20px;
    border-radius: 12px;
    width: 100%;
    max-width: 920px;
    display: flex;
    flex-direction: column;
    height: 570px;
}
#question-card-container {
    flex-grow: 1;
}

.stats-question-title {
    font-size: 0.9rem;
    font-weight: bold;
    margin-bottom: 12px;
    color: #fff;
    margin-top: 20px;
}

.stats-legend {
    margin-top: 20px;
    padding-top: 15px;
    display: flex;
    justify-content: center;
    gap: 20px;
    position: relative;
    flex-wrap: wrap;
}
.progress-line-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 1px;
    background-color: rgba(255, 255, 255, 0.2);
}
.progress-line-fill {
    width: 0%;
    height: 100%;
    background-color: #a2d2ff;
    transition: width 0.4s ease-out;
    box-shadow: 0 0 8px rgba(162, 210, 255, 0.9), 0 0 15px rgba(0, 191, 255, 0.7);
}
.stats-freetext-answers-container {
    padding-right: 10px;
}
.stats-freetext-answer-item {
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 6px;
    padding: 10px 15px;
    margin-bottom: 8px;
    color: #eee;
    font-size: 0.95rem;
    line-height: 1.5;
    border-left: 3px solid #007bff;
    word-wrap: break-word;
    word-break: break-all;
}
.stats-freetext-no-answers {
    color: #ccc;
    text-align: center;
    padding-top: 40px;
    font-style: italic;
    opacity: 0.7;
}
.stats-legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
    color: #ccc;
}
.stats-legend-color-box {
    width: 15px;
    height: 15px;
}

.stats-answer-item {
    background-color: rgba(0, 0, 0, 0.25);
    border-radius: 8px;
    padding: 12px;
    color: #fff;
    font-size: 0.90rem;
    flex-grow: 1;
    min-height: 70px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.stats-answer-text-container {
    flex-basis: 35%;
    flex-shrink: 0;
}

.stats-bar-wrapper {
    flex-grow: 1;
    height: 25px;
    position: relative;
    background-color: rgba(0, 0, 0, 0.3);
    border-radius: 5px;
    overflow: hidden;
}

.stats-stacked-bar-container {
    display: flex;
    width: 100%;
    height: 100%;
}

.stats-bar-segment {
    height: 100%;
    transition: width 0.5s ease-in-out;
}

.stats-answer-total {
    flex-basis: 60px;
    flex-shrink: 0;
    text-align: right;
    font-weight: bold;
    font-size: 1.1rem;
    color: #ccc;
}

.stats-answer-text {
    position: relative;
    z-index: 2;
    word-break: break-all;
}

.stats-nav-button {
    cursor: pointer;
    color: #fff;
    opacity: 0.7;
    transition: opacity 0.2s;
}

.stats-nav-button:hover {
    opacity: 1;
}

.stats-nav-button.disabled {
    opacity: 0.2;
    cursor: not-allowed;
}
.stats-answer-row {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 10px;
}

.stats-answer-text {
    display: block;
    margin-bottom: 8px;
}

.stats-mini-bars-container {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.stats-mini-bar {
    height: 3px;
    border-radius: 3px;
    transition: width 0.5s ease-in-out;
}

.stats-answer-breakdown-counts {
    display: flex;
    flex-direction: column;
    gap: 2px;
    flex-shrink: 0;
    min-width: 50px;
}

.stats-company-count {
    font-size: 0.85rem;
    color: #ccc;
    display: flex;
    align-items: center;
    gap: 8px;
}

.stats-company-count span:first-child {
    font-size: 1.2rem;
    line-height: 1;
}

.all-surveys-layout {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 25px;
    height: 100%;
    min-height: 0;
    margin-top: -47px;
}
.participant-list-container {
    display: flex;
    flex-direction: column;
    min-height: 0;
    background: rgba(0, 0, 0, 0.2);
    padding: 20px;
    border-radius: 12px;
}
#participant-search {
    width: 100%;
    padding: 10px 15px;
    margin-bottom: 15px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    color: #fff;
    font-size: 0.95rem;
}
.participant-list-header {
    display: grid;
    /* SURVEY | PARTICIPANT | GAP | AGE | COMPANY | DATE | RATING | DUPLICATE | ACTIONS */
    grid-template-columns: 1.2fr 1.5fr 0.3fr 0.5fr 1fr 1.5fr 0.4fr 0.5fr 0.3fr;
    gap: 5px;
    padding: 0 10px 10px;
    font-weight: bold;
    color: #ccc;
    font-size: 0.85rem;
    border-bottom: 1px solid rgba(0, 123, 255, 0.4);
    flex-shrink: 0;
}
.participant-list {
    list-style: none;
    padding: 0;
    margin: 0;
    overflow-y: auto;
    flex-grow: 1;
}
.participant-list-item {
    display: grid;
    /* SURVEY | PARTICIPANT | GAP | AGE | COMPANY | DATE | RATING | DUPLICATE | ACTIONS */
    grid-template-columns: 1.2fr 1.5fr 0.3fr 0.5fr 1fr 1.5fr 0.4fr 0.5fr 0.3fr;
    gap: 5px;
    padding: 12px 10px;
    font-size: 0.9rem;
    border-bottom: 1px solid rgba(0, 123, 255, 0.2);
    cursor: pointer;
    transition: background-color 0.2s;
}
.participant-list-item:hover {
    background-color: rgba(0, 123, 255, 0.15);
}
.participant-list-item span {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.participant-delete-action {
    text-align: right;
}
.delete-participant-btn {
    background: none;
    border: none;
    color: #ff4d4d;
    cursor: pointer;
    font-size: 1.5rem;
    line-height: 1;
    padding: 0 5px;
    transition: all 0.2s ease;
}
.delete-participant-btn:hover {
    color: #fff;
    transform: scale(1.2);
}
.stats-sub-header {
    display: none;
    align-items: center;
    gap: 20px;
    margin-bottom: 5px;
}
#single-survey-content .participant-list-container {
    margin-top: 0;
}
.view-icon-switcher {
    display: flex;
    gap: 15px;
    flex-direction: row;
    position: relative;
    z-index: 10;
    margin-bottom: 15px;
    justify-content: flex-start;
}
.view-icon-btn {
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: #ccc;
    border-radius: 8px;
    cursor: pointer;
    width: auto;
    height: auto;
    padding: 8px 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-size: 0.95rem;
    transition: all 0.2s ease-in-out;
}
.view-icon-btn:hover {
    background: rgba(0, 0, 0, 0.4);
    color: #fff;
}
.view-icon-btn.active {
    background: #007bff;
    color: #fff;
    border-color: #007bff;
}
.text-summary-stats {
    color: #ccc;
    font-size: 0.95rem;
    font-family: 'Montserrat', sans-serif;
    margin-bottom: 10px;
}
.text-summary-stats b {
    color: #fff;
    font-weight: bold;
}

#stats-view-container {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    min-height: 0;
}
.all-surveys-layout, #single-survey-content-wrapper {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    min-height: 0;
}
.all-surveys-layout .text-summary-stats {
    margin-top: 24px;
    margin-bottom: -17px;
}
.participant-list-container {
    flex-grow: 1;
}

#single-survey-content {
    flex-grow: 1;
    min-height: 0;
    margin-top: -20px;
    display: flex;
    flex-direction: column;
}
.participant-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(14, 42, 71, 0.85);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    z-index: 3000;
    display: flex;
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.3s ease;
}
.participant-modal-content {
    background: rgba(0, 80, 150, 0.35);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(0, 123, 255, 0.4);
    padding: 25px 40px;
    border-radius: 15px;
    width: 90%;
    max-width: 700px;
    height: 80vh;
    color: #fff;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
    display: flex;
    flex-direction: column;
}
.participant-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid rgba(0, 123, 255, 0.5);
    padding-bottom: 15px;
    margin-bottom: 20px;
    flex-shrink: 0;
}
.participant-modal-header h2 {
    font-family: 'Poppins', sans-serif;
    font-size: 1.6rem;
    color: #fff;
    margin: 0;
}
.participant-modal-close {
    background: none;
    border: none;
    color: #ccc;
    font-size: 2rem;
    cursor: pointer;
    transition: color 0.2s, transform 0.2s;
}
.participant-modal-close:hover {
    color: #fff;
    transform: rotate(90deg);
}
.participant-modal-body {
    overflow-y: auto;
    padding-right: 15px;
}
.participant-modal-details {
    text-align: right;
    font-size: 0.85rem;
    color: #ccc;
    line-height: 1.4;
}
.participant-modal-details b {
    color: #fff;
    font-weight: 700;
}
.qa-card {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 10px;
    padding: 15px 20px;
    margin-bottom: 15px;
    border-left: 4px solid #007bff;
}
.qa-card-question {
    font-weight: 400;
    color: #ccc;
    font-size: 0.95rem;
    margin-bottom: 8px;
}
.qa-card-answer {
    font-size: 1.05rem;
    color: #fff;
    word-wrap: break-word;
    font-weight: 700;
}
.qa-card-score {
    font-size: 0.85rem;
    font-weight: bold;
    color: #00aaff;
    margin-left: 10px;
}
.top-answers-container {
    display: flex;
    flex-direction: column;
    height: 100%;
}
.top-answers-controls {
    display: flex;
    margin-bottom: 5px;
}
.top-answers-table-wrapper {
    flex-grow: 1;
    overflow-y: auto;
    overflow-x: hidden;
}
#single-survey-content .participant-list {
    overflow-y: auto;
    max-height: 500px;
}


.top-answers-table {
    width: 100%;
    border-collapse: collapse;
    color: #fff;
    table-layout: fixed;
}

.top-answers-table th:nth-child(1) {
    width: 60px;
}
.top-answers-table th:nth-child(3) {
    width: 90px;
}
.top-answers-table th:nth-child(4) {
    width: 120px;
}
.top-answers-table th:nth-child(5) {
    width: 120px;
}

.top-answers-table th, .top-answers-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid rgba(0, 123, 255, 0.2);
    vertical-align: middle;
}
.top-answers-table th {
    font-size: 0.9rem;
    color: #ccc;
    text-transform: uppercase;
    position: sticky;
    top: 0;
    background: #1c3a59;
    z-index: 10;
    text-align: center;
}
.top-answers-table th:nth-child(2) {
    padding-left: 0;
}
.top-answers-table th:nth-child(3),
.top-answers-table th:nth-child(4),
.top-answers-table th:nth-child(5) {
    text-align: right;
}

.top-answers-row .rank {
    font-size: 1.5rem;
    font-weight: bold;
    color: #007bff;
    text-align: left;
}
.top-answers-row .answer-details {
    word-wrap: break-word;
    padding-left: 0;
    padding-right: 15px;    
}
.top-answers-row .question {
    font-size: 0.85rem;
    color: #ccc;
    display: block;
    margin-bottom: 5px;
}
.top-answers-row .answer {
    font-size: 1.1rem;
    font-weight: bold;
}
.top-answers-row .count,
.top-answers-row .percentage {
    font-size: 1.1rem;
    font-weight: bold;
    text-align: right;
    color: #ccc;
}
.top-answers-row .percentage {
    color: #fff;
}
.top-answers-row .answer-details {
    position: relative;
}

.top-answers-row .answer-details:hover::after {
    content: attr(data-survey);
    position: absolute;
    bottom: 105%;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    background-color: #007bff;
    color: #fff;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: bold;
    white-space: nowrap;
    opacity: 1;
    visibility: visible;
    transition: opacity 0.2s ease, visibility 0.2s ease;
}

.top-answers-row .answer-details::after {
    content: '';
    position: absolute;
    opacity: 0;
    visibility: hidden;
}
.admin-answer-group .answer-text-input {
    width: auto;
    flex-grow: 1;
}
.admin-answer-group .answer-score-select {
    width: 80px !important;
    flex-shrink: 0;
}
.top-answers-controls {
    display: flex;
    gap: 25px;
    margin-bottom: 15px;
    padding-left: 5px;
}
.top-answers-limit-btn {
    background: none;
    border: none;
    color: #ccc;
    font-size: 1rem;
    font-family: 'Poppins', sans-serif;
    cursor: pointer;
    transition: color 0.2s ease;
    padding: 0;
}
.top-answers-limit-btn:hover {
    color: #fff;
}
.top-answers-limit-btn.active {
    color: #007bff;
    font-weight: 700;
}
.clear-filters-wrapper {
    text-align: right;
    margin: -12px 0 -10px 0;
    position: relative;
    z-index: 10;
}
.clear-filters-btn {
    background: none;
    border: none;
    color: #ccc;
    font-size: 0.85rem;
    cursor: pointer;
    transition: color 0.2s;
    padding: 5px;
}
.clear-filters-btn:hover {
    color: #fff;
    text-decoration: underline;
}
.sortable-header {
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
    user-select: none;
    transition: color 0.2s;
}
.sortable-header[data-sort-by="survey"]      { padding-left: -10px; }
.sortable-header[data-sort-by="participant"] { padding-left: -10px; }
.sortable-header[data-sort-by="age"]         { padding-left: -10px; }
.sortable-header[data-sort-by="company"]     { padding-left: -7px; }
.sortable-header[data-sort-by="date"]        { padding-left: 25px; }
.sortable-header[data-sort-by="rate"]        { padding-left: 0; justify-content: flex-start; }
.sortable-header:hover {
    color: #fff;
}
.sort-icon {
    font-size: 1.2em;
    line-height: 1;
    color: #888;
}
.sortable-header.active .sort-icon {
    color: #fff;
}
.sort-icon.asc::after {
    content: '↑';
}
.sort-icon.desc::after {
    content: '↓';
}
#single-survey-content-wrapper .text-summary-stats {
    margin-top: 0;
    margin-bottom: 0;
}
.admin-list-header,
.admin-list-item {
    grid-template-columns: 1fr 80px 180px 100px;
}

.admin-list-item-url {
    text-align: center;
}

.url-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 5px;
    border-radius: 5px;
    transition: background-color 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.url-btn svg {
    fill: #ccc;
    transition: fill 0.2s;
}

.url-btn:hover {
    background-color: rgba(0, 123, 255, 0.2);
}

.url-btn:hover svg {
    fill: #fff;
}

.url-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(14, 42, 71, 0.85);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    z-index: 3000;
    display: flex;
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.3s ease;
}

.url-modal-content {
    background: rgba(0, 80, 150, 0.35);
    padding: 25px 40px;
    border-radius: 15px;
    width: 90%;
    max-width: 700px;
    color: #fff;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
    display: flex;
    flex-direction: column;
}

.url-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid rgba(0, 123, 255, 0.5);
    padding-bottom: 15px;
    margin-bottom: 20px;
}

.url-modal-header h2 {
    font-family: 'Poppins', sans-serif;
    font-size: 1.4rem;
    margin: 0;
}

.url-modal-close {
    background: none;
    border: none;
    color: #ccc;
    font-size: 2rem;
    cursor: pointer;
    transition: color 0.2s, transform 0.2s;
}

.url-modal-close:hover {
    color: #fff;
    transform: rotate(90deg);
}
.url-modal-body {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.link-entry {
    display: grid;
    grid-template-columns: 120px 1fr auto;
    align-items: center;
    gap: 10px;
}

.link-entry .company-name {
    font-weight: bold;
    color: #ccc;
    flex-shrink: 0;
}

.link-entry .link-text-input {
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: #fff;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.9rem;
}

.link-actions {
    display: flex;
    gap: 5px;
}

.copy-link-btn,
.go-to-link-btn {
    background: none;
    border: 1px solid #aaa;
    color: #ccc;
    cursor: pointer;
    padding: 8px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.copy-link-btn:hover,
.go-to-link-btn:hover {
    background: #ccc;
    color: #333;
    border-color: #ccc;
}
.progress-bar-container {
    display: flex;
    gap: 4px;
    width: 100%;
    max-width: 280px;
    height: 6px;
    margin-top: 15px;
}

.progress-bar-segment {
    flex: 1;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.3);
    border-radius: 3px;
    transition: background-color 0.4s ease;
}

.progress-bar-segment.active {
    background-color: var(--accent-color);
    box-shadow: 0 0 8px var(--accent-color);
}

@keyframes slide-in-question-reverse {
    from {
        opacity: 0;
        transform: translateX(-30px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes slide-out-question-reverse {
    from {
        opacity: 1;
        transform: translateX(0);
    }
    to {
        opacity: 0;
        transform: translateX(30px);
    }
}

.slide-in-question.from-back {
    animation: slide-in-question-reverse 0.4s ease-out;
}

.slide-out-question-reverse {
    animation: slide-out-question-reverse 0.4s ease-out forwards;
}
.update-notification-modal {
    position: fixed;
    bottom: 25px;
    right: 25px;
    background: rgba(0, 80, 150, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    color: #fff;
    padding: 20px 25px;
    border-radius: 12px;
    box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
    z-index: 4000;
    width: 90%;
    max-width: 350px;
    animation: slideInUp 0.5s ease-out;
    border: 1px solid rgba(0, 123, 255, 0.5);
}
.update-notification-modal h3 {
    font-family: 'Poppins', sans-serif;
    font-size: 1.2rem;
    margin: 0 0 10px 0;
    display: flex;
    align-items: center;
    gap: 10px;
    color: #a2d2ff;
}
.update-notification-modal ul {
    list-style: none;
    padding: 0;
    margin: 0 0 15px 0;
}
.update-notification-modal li {
    padding: 5px 0;
    font-size: 0.95rem;
    border-bottom: 1px solid rgba(0, 123, 255, 0.2);
}
.update-notification-modal li:last-child {
    border-bottom: none;
}
.update-notification-modal button {
    background: rgba(0, 123, 255, 0.5);
    color: #fff;
    border: none;
    padding: 8px 15px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s;
    width: 100%;
    font-weight: bold;
}
.update-notification-modal button:hover {
    background: rgba(0, 123, 255, 0.7);
}
@keyframes slideInUp {
    from { transform: translateY(100%); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
.live-toast-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(40, 167, 69, 0.9); 
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    color: #fff;
    padding: 15px 20px;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
    z-index: 5000;
    width: auto;
    max-width: 320px;
    animation: slideInFromRight 0.5s ease-out;
    border: 1px solid rgba(255, 255, 255, 0.2);
}
.live-toast-notification h4 {
    margin: 0 0 8px 0;
    font-size: 1rem;
    font-weight: 700;
}
.live-toast-notification ul {
    list-style: none;
    padding: 0;
    margin: 0;
    font-size: 0.9rem;
}
@keyframes slideInFromRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
.custom-welcome-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(14, 42, 71, 0.85);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    z-index: 4500;
    display: flex;
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.3s ease;
}

.custom-welcome-modal-content {
    background: rgba(0, 80, 150, 0.45);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(0, 123, 255, 0.5);
    padding: 30px 40px;
    border-radius: 15px;
    width: 90%;
    max-width: 550px;
    color: #fff;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
    text-align: center;
}

.custom-welcome-modal-content h2 {
    font-family: 'Poppins', sans-serif;
    font-size: 1.8rem;
    margin: 0 0 20px 0;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
}

.custom-welcome-modal-content ul {
    list-style: none;
    padding: 0;
    margin: 0 0 25px 0;
    text-align: left;
}

.custom-welcome-modal-content li {
    padding: 8px 0;
    font-size: 1.05rem;
    border-bottom: 1px solid rgba(0, 123, 255, 0.2);
}
.custom-welcome-modal-content li:last-child {
    border-bottom: none;
}

.custom-welcome-modal-content button {
    background: #007bff;
    color: #fff;
    border: none;
    padding: 12px 30px;
    font-size: 1.1rem;
    font-weight: bold;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
    box-shadow: 0 4px 15px rgba(0,123,255,0.3);
}

.custom-welcome-modal-content button:hover {
    background: #0069d9;
    box-shadow: 0 7px 20px rgba(0,123,255,0.4);
}
.initial-admin-loader-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 5000;
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
    background-color: rgba(14, 42, 71, 0.85);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
}
.initial-admin-loader-overlay.visible {
    opacity: 1;
}
.loader-content {
    text-align: center;
    color: #fff;
    font-family: 'Poppins', sans-serif;
    animation: pulse 2s infinite ease-in-out;
}
.loader-content svg {
    width: 80px;
    height: 80px;
    fill: #fff;
    margin-bottom: 10px; 
    animation: rotateAdminIcon 2.5s linear infinite;
}
.loader-content h2 {
    font-size: 1.8rem;
    font-weight: 700;
    letter-spacing: 1px;
}
.loader-dots {
    display: inline-block;
    position: relative;
    width: 80px;
    height: 40px;
}
.loader-dots::after {
    content: ' .';
    font-size: 3rem;
    animation: dots 1.4s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.05); opacity: 0.8; }
    100% { transform: scale(1); opacity: 1; }
}

@keyframes rotateAdminIcon {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
.alert-modal {
    background: rgba(0, 80, 150, 0.45);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(0, 123, 255, 0.5);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
    color: #fff;
    padding: 30px 40px;
    border-radius: 15px;
    font-family: 'Poppins', sans-serif;
}
.alert-modal p {
    color: #fff;
    font-size: 1.1rem;
}
.alert-modal button {
    background: #007bff;
    box-shadow: 0 4px 15px rgba(0,123,255,0.3);
    border-radius: 8px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.3s ease;
}
.alert-modal button:hover {
    background: #0069d9;
    box-shadow: 0 7px 20px rgba(0,123,255,0.4);
}

.custom-welcome-modal-content li {
    font-size: 1rem;
    padding: 10px 5px;
}
.custom-welcome-modal-content li b, 
.custom-welcome-modal-content li em {
    color: #a2d2ff;
}


.live-toast-notification {
    background: rgba(0, 123, 255, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.3);
}
.live-toast-notification h4 {
    display: flex;
    align-items: center;
    gap: 8px;
}
.live-toast-notification h4::before {
    content: '🔔';
}
.live-toast-notification li b,
.live-toast-notification li em {
    color: #d4eaff;
}
.question-header .question-text-group {
    flex-grow: 1;
}

.question-type-group,
.delete-question-btn-wrapper {
    transition: max-width 0.4s ease-out, opacity 0.2s 0.2s, margin 0.4s ease-out, padding 0.4s ease-out;
    max-width: 200px;
    overflow: hidden;
}

.custom-multiselect {
    position: relative;
    font-family: 'Montserrat', sans-serif;
}
.custom-multiselect .select-display {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid rgba(255, 255, 255, 0.5);
    border-radius: 8px;
    font-size: 0.95rem;
    background: transparent;
    color: #fff;
    cursor: pointer;
    user-select: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 1em;
    padding-right: 2.5rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    height: 38px;
    line-height: 1.5;
}
.custom-multiselect.open .select-display {
    border-color: #fff;
}
.custom-multiselect .select-options {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    z-index: 100;
    background: #1c3a59;
    border: 1px solid rgba(255, 255, 255, 0.5);
    border-radius: 8px;
    margin-top: 4px;
    max-height: 200px;
    overflow-y: auto;
    color: #fff;
}
.custom-multiselect.open .select-options {
    display: block;
}
.custom-multiselect .select-options ul {
    list-style: none;
    margin: 0;
    padding: 5px 0;
}
.custom-multiselect .select-options li {
    padding: 5px 15px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    -webkit-user-select: none;
    -ms-user-select: none;
    user-select: none;
     font-size: 0.85rem;
}
.custom-multiselect .select-options li:hover {
    background-color: rgba(0, 123, 255, 0.2);
}
.custom-multiselect .select-options input[type="checkbox"] {
    width: 16px;
    height: 16px;
    pointer-events: none;
}
.custom-select {
    position: relative;
    font-family: 'Montserrat', sans-serif;
}
.custom-select .select-display {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid rgba(255, 255, 255, 0.5);
    border-radius: 8px;
    font-size: 0.95rem;
    background: transparent;
    color: #fff;
    cursor: pointer;
    user-select: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 1em;
    padding-right: 2.5rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    height: 38px;
    line-height: 1.5;
}
.custom-select.open .select-display {
    border-color: #fff;
}
.custom-select .select-options {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    z-index: 100;
    background: #1c3a59;
    border: 1px solid rgba(255, 255, 255, 0.5);
    border-radius: 8px;
    margin-top: 4px;
    max-height: 200px;
    overflow-y: auto;
    color: #fff;
}
.custom-select.open .select-options {
    display: block;
}
.custom-select .select-options ul {
    list-style: none;
    margin: 0;
    padding: 5px 0;
}
.custom-select .select-options li {
    padding: 5px 15px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    -webkit-user-select: none;
    -ms-user-select: none;
    user-select: none;
    gap: 10px;
    font-size: 0.85rem;
}
.custom-select .select-options li:hover {
    background-color: rgba(0, 123, 255, 0.2);
}
.custom-select .tick-mark {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3e%3cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3e%3c/svg%3e");
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    opacity: 0;
    transition: opacity 0.2s ease-in-out;
}
.custom-select .select-options li.selected .tick-mark {
    opacity: 1;
}
.answer-score-select option,
.question-type-group .admin-select option {
    background: #1c3a59; 
    color: #ffffff;     
}
.stats-answer-breakdown-counts div[style*="#FFD700"] {
    font-size: 0.8rem;  
    padding-right: 10px; 
}
.timeline-chart-nav {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-top: 0px;
}
.timeline-chart-nav-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.3);
    cursor: pointer;
    transition: background-color 0.3s ease;
}
.timeline-chart-nav-dot.active {
    background-color: #007bff;
}
.timeline-info-icon {
    position: absolute;
    top: 15px;
    right: 20px;
    cursor: help;
    color: rgba(255, 255, 255, 0.5);
    z-index: 10;
}
.timeline-info-icon svg {
    width: 20px;
    height: 20px;
    fill: currentColor;
}
.timeline-info-icon:hover {
    color: rgba(255, 255, 255, 1);
}
.timeline-info-icon::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 120%;
    right: -20px;
    transform: translateX(0);
    background-color: #007bff;
    color: #fff;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.85rem;
    font-family: 'Montserrat', sans-serif;
    white-space: normal;
    width: 280px;
    text-align: left;
    line-height: 1.5;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease, visibility 0.2s ease;
    pointer-events: none;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}
.timeline-info-icon:hover::after {
    opacity: 1;
    visibility: visible;
}
.stats-question-card {
    position: relative;
}
.stats-question-card .timeline-info-icon {
    position: absolute;
    top: 15px;
    right: 20px;
    cursor: help;
    color: rgba(255, 255, 255, 0.5);
    z-index: 10;
}
.stats-question-card .timeline-info-icon svg {
    width: 20px;
    height: 20px;
    fill: currentColor;
}
.stats-question-card .timeline-info-icon:hover {
    color: rgba(255, 255, 255, 1);
}
.stats-question-card .timeline-info-icon::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 120%;
    right: -20px;
    transform: translateX(0);
    background-color: #007bff;
    color: #fff;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.85rem;
    font-family: 'Montserrat', sans-serif;
    white-space: normal;
    width: 280px;
    text-align: left;
    line-height: 1.5;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease, visibility 0.2s ease;
    pointer-events: none;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}
.stats-question-card .timeline-info-icon:hover::after {
    opacity: 1;
    visibility: visible;
}
.th-content-wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 4px;
    white-space: nowrap;
}
.info-icon {
    display: inline-block;
    position: relative;
    cursor: help;
    vertical-align: middle;
    line-height: 1;
}
.info-icon svg {
    width: 16px;
    height: 16px;
    fill: #ccc;
    transition: fill 0.2s;
}
.info-icon:hover svg {
    fill: #fff;
}
.info-icon::before, .info-icon::after {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease, visibility 0.2s ease;
    pointer-events: none;
    z-index: 100;
}
.info-icon::after {
    content: attr(data-tooltip);
    top: calc(100% + 10px);
    background-color: #007bff;
    color: #fff;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.85rem;
    font-family: 'Montserrat', sans-serif;
    white-space: normal;
    width: 250px;
    text-align: left;
    line-height: 1.5;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    text-transform: none;
    font-weight: normal;
}
.top-answers-table th:last-child .info-icon::after {
    left: auto;
    right: 0;
    transform: translateX(0);
}
.top-answers-table th:last-child .info-icon::before {
    left: auto;
    right: 8px;
    transform: translateX(0);
}
.info-icon::before {
    content: '';
    top: 100%;
    border: 5px solid transparent;
    border-bottom-color: #007bff;
}
.info-icon:hover::before, .info-icon:hover::after {
    opacity: 1;
    visibility: visible;
}
.top-answers-table th:nth-child(2) .sortable-header {
    justify-content: center;
}
.admin-info-icon-wrapper {
    position: absolute;
    top: 25px;
    right: 40px;
    cursor: help;
    z-index: 10;
}

.admin-info-icon-wrapper svg {
    width: 24px;
    height: 24px;
    fill: #ccc;
    transition: fill 0.2s ease-in-out;
}

.admin-info-icon-wrapper:hover svg {
    fill: #fff;
}

.admin-info-icon-wrapper::after {
    content: attr(data-tooltip);
    position: absolute;
    top: 0; 
    right: 105%; 
    width: 320px;
    background-color: #007bff;
    color: #fff;
    padding: 12px 15px;
    border-radius: 8px;
    font-size: 0.9rem;
    font-family: 'Montserrat', sans-serif;
    line-height: 1.6;
    text-align: left;
    white-space: pre-wrap;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
    z-index: 1000; 
}

.admin-info-icon-wrapper:hover::after {
    opacity: 1;
    visibility: visible;
}
#custom-tooltip {
    position: fixed;
    display: none;
    opacity: 0;
    background-color: #007bff;
    color: #fff;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.9rem;
    font-family: 'Montserrat', sans-serif;
    max-width: 280px;
    text-align: center;
    z-index: 4000;
    pointer-events: none;
    transition: opacity 0.1s ease-in-out;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}
.question-text-group .admin-input {
    background-color: rgba(0, 123, 255, 0.25);
}
.admin-answer-group .answer-text-input {
    background-color: #ffffff;
    color: #000;
}
.admin-answer-group .answer-text-input::placeholder {
    color: #888;
}
.admin-answer-group {
    display: flex; 
    align-items: center;
    gap: 10px;
}


.answer-input-wrapper {
    position: relative;
    display: flex;
    flex-grow: 1; 
    align-items: center;
}

.answer-input-wrapper .answer-text-input {
    padding-right: 40px; 
    width: 100%;
}

.textfield-toggle-icon {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    opacity: 0.12;
    transition: opacity 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.textfield-toggle-icon img {
    width: 20px;
    height: 20px;
}
.textfield-toggle-icon:hover,
.textfield-toggle-icon.enabled {
    opacity: 1;
}

.icon-with-tooltip-wrapper {
    position: relative; 
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.tooltip {
    visibility: hidden; 
    width: 220px; 
    background-color: #007bff; 
    color: #fff; 
    text-align: center;
    border-radius: 6px;
    padding: 8px 12px;
    position: absolute;
    z-index: 10;
    bottom: 140%; 
    left: 50%;
    transform: translateX(-50%); 
    transition: opacity 0.3s;
    font-size: 0.9rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
}


.tooltip::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: #007bff transparent transparent transparent;
}

.icon-with-tooltip-wrapper:hover .tooltip {
    visibility: visible;
    opacity: 1;
}
.admin-textarea {
    width: 100%;
    min-height: 80px;
    padding: 12px 15px;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 1rem;
    font-family: 'Montserrat', sans-serif;
    background: #ffffff;
    color: #333;
    resize: vertical;
}

.admin-textarea::placeholder {
    color: #888;
}

.hidden {
    display: none !important;
}
.input-error {
    border: 1px solid #ff4d4d !important;
    box-shadow: 0 0 5px rgba(255, 77, 77, 0.5);
}

.error-message {
    color: #ff6b6b;
    font-size: 0.85rem;
    display: block;
    padding-left: 2px;
    text-align: left;
}

.admin-form-group + .error-message {
    margin-top: -20px; 
}

.question-text-group + .error-message {
    margin-top: 5px;
    transform: translateX(-25px);
}

.answer-input-wrapper + .error-message {
    margin-top: 0px;
}
.rating-preview-container {
    display: flex;
    gap: 10px;
    margin-top: 15px;
    padding: 10px;
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
    pointer-events: none; 
}

.rating-preview-item {
    font-size: 1.2rem;
    font-weight: bold;
    color: #888;
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid #888;
    border-radius: 0;
}

.rating-preview-star svg {
    width: 35px;
    height: 35px;
    fill: #888;
}

.rating-user-container {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin: 20px 0;
}

.rating-number {
    font-size: 1.2rem;
    font-weight: bold;
    color: #333;
    background-color: #fff;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid #ccc;
    border-radius: 0;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}

.rating-number:hover {
    transform: scale(1.1);
    border-color: var(--accent-color);
}
.rating-number.selected {
    background-color: var(--accent-color);
    color: #fff;
    border-color: var(--accent-color);
}

.rating-star {
    cursor: pointer;
    transition: transform 0.2s ease-in-out;
}

.rating-star svg {
    width: 40px;
    height: 40px;
    fill: #ccc;
    transition: fill 0.2s;
}

.rating-star:hover {
    transform: scale(1.1);
}

.rating-star.selected svg {
    fill: #FFD700; 
}
.sort-icon.desc::after {
    content: '↓';
}
.average-rating-display {
    padding: 8px 10px;
    font-size: 1.1rem;
    font-weight: bold;
    color: #fff;
    border-top: 1px solid rgba(0, 123, 255, 0.4);
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: flex-end;
}
.average-rating-display span {
    color: #ccc;
    font-weight: normal;
    font-size: 1rem;
    margin-right: 8px;
}
.other-input-inline {
    display: none; 
    flex-grow: 1;
    border: none;
    background: transparent;
    border-bottom: 1px solid #999;
    padding: 2px;
    font-family: inherit;
    font-size: inherit;
    color: inherit;
    outline: none;
    width: auto;
}
.question-option.selected .other-input-inline {
    display: inline-block; 
}
.admin-question-block.collapsed {
    padding-top: 12px;
    padding-bottom: 12px;
    cursor: pointer;
}
.survey-alert {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}
.survey-alert p {
    color: #212529;
    font-size: 1.1rem;
}
.survey-alert button {
    background-color: var(--accent-color);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-radius: 50px;
    padding: 10px 25px;
}

.smj-theme-layout .survey-alert {
    background: #ffffff;
    border: 2px solid var(--accent-color);
}
.smj-theme-layout .survey-alert p {
    color: #333;
}
.smj-theme-layout .survey-alert button {
    background-color: var(--accent-color);
}

.eb-theme-layout .survey-alert {
    background: #1c3a59;
    border: 1px solid var(--accent-color);
    box-shadow: 0 0 20px rgba(0, 123, 255, 0.4);
}
.eb-theme-layout .survey-alert p {
    color: #fff;
}
.eb-theme-layout .survey-alert button {
    background-color: var(--accent-color);
}
.question-block-wrapper {
    position: relative;
}

.drag-handle {
    cursor: grab;
    margin-right: 8px; 
    opacity: 0.6;
    transition: opacity 0.2s ease;
    width: 24px;
    height: 24px;
    align-self: center; 
}

.drag-handle:hover {
    opacity: 1;
}

.question-block-wrapper.dragging {
    opacity: 0.3; 
    background: transparent;
    border-color: rgba(0, 123, 255, 0.5);
    border-style: dashed;
}
.duplicate-label {
    color: red;
    border: 1px solid red;
    padding: 2px 3px;
    border-radius: 4px;
    font-weight: bold;
    text-align: left;
    font-size: 0.7rem;
}
.participant-list-header > span:nth-child(2),
.participant-list-item > span:nth-child(2) {
    padding-left: 18px;
}
.alert-modal-actions {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 20px;
}

.alert-modal-actions button {
    margin-top: 0; 
}

.alert-modal-actions .delete-all-btn {
    background: #dc3545;
    box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
}
.alert-modal-actions .delete-all-btn:hover {
    background: #c82333;
    box-shadow: 0 7px 20px rgba(220, 53, 69, 0.4);
}
.alert-modal-actions .cancel-btn {
    background: #6c757d;
    box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
}
.alert-modal-actions .cancel-btn:hover {
    background: #5a6268;
    box-shadow: 0 7px 20px rgba(108, 117, 125, 0.4);
}
    </style>
</head>
<body>
    <div id="admin-panel-container"></div>
    <header class="main-header">
        <div class="logo">
            <img src="" alt="Company Logo" class="logo-icon">
            <h1 class="logo-text">SURVEY</h1>
        </div>
    </header>
    <div class="background-container"></div>
    <div class="container" id="main-content">
    </div>
<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwWe1vUolb20OFSh5J8UWrFOWevp755WjipHUTYVsd8THcIG7tToWdWmxF9AstJLh5yBg/exec';
    let companyConfig = {};
    let adminDataCache = null;
    let surveyListSortKey = 'lastModified';
    let surveyListSortDirection = 'desc';
    let cacheIntervalId = null;
    let timelineChartInstance = null;
    let refreshAdminStatsView = () => {};
    document.addEventListener('DOMContentLoaded', () => {
    
    const mainContent = document.getElementById('main-content');
    const mainHeader = document.querySelector('.main-header');
    const adminPanelContainer = document.getElementById('admin-panel-container');
    const userAnswers = {};
    let surveyQuestions = [];
    let currentQuestionIndex = 0;
    let surveyId = '';
    let allSurveys = [];
    let companyName = '';
    const themes = {
    'SMJ': {
        code: '47kDs45B87ms5y8',
        logo: 'https://images.squarespace-cdn.com/content/v1/65dcc6ddc23f46020d153086/e0b56a73-e4fc-4812-aaa7-1a2d9b734504/Logo-SMJ.png',
        color: '#d93025',
        secondaryColor: '#ffffff',
        accentColor: '#d93025',
        accentHoverColor: '#a8241c',
        selectionBorderColor: '#d93025',
        suggestedLinkBg: '#d93025',
        suggestedLinkHoverBg: '#a8241c',
        overlayColor: 'rgba(181, 154, 106, 0.85)',
        welcomeTextColor: '#ffffff',
        welcomeLogoTitleColor: '#ffffff',
        questionCardBg: 'rgba(181, 154, 106, 0.5)',
        questionTitleColor: '#ffffff',
        questionOptionTextColor: '#000000',
        finalPageSubtitleColor: '#333333',
        backTextColor: '#f0f0f0'
    },
    'EB Infinity': {
        code: 'mL8754HGyma91sc',
        logo: 'https://images.squarespace-cdn.com/content/v1/67734e14b025c127a03e5730/2ed49605-95db-4d98-a715-77c77663dd69/Blue+Modern+Infinity+Loop+Business+Consulting+Logo.png',
        color: '#007bff',
        secondaryColor: '#ffffff',
        accentColor: '#007bff',
        accentHoverColor: '#0056b3',
        selectionBorderColor: '#007bff',
        suggestedLinkBg: '#007bff',
        suggestedLinkHoverBg: '#0056b3',
        overlayColor: 'rgba(75, 75, 75, 0.85)',
        welcomeTextColor: '#ffffff',
        welcomeLogoTitleColor: '#007bff',
        questionCardBg: 'rgba(0, 0, 0, 0.25)',
        questionTitleColor: '#ffffff',
        questionOptionTextColor: '#000000',
        finalPageSubtitleColor: '#333333',
        backTextColor: '#f0f0f0'
    },
    'AmongUs': {
        code:'l2BY8igh90mMHg4',
        logo: 'https://images.squarespace-cdn.com/content/v1/67816277ce6fe832dd037896/dbe69b84-b7dc-4b22-a542-0f4d512178b0/AMONG-US-Logo-Icon-horizontal.png?format=1500w',
        color: '#ff6600',
        secondaryColor: '#333333',
        accentColor: '#ff6600',
        accentHoverColor: '#e65c00',
        selectionBorderColor: '#007bff',
        suggestedLinkBg: '#007bff',
        suggestedLinkHoverBg: '#0056b3',
        overlayColor: 'rgba(255, 255, 255, 0.85)',
        welcomeTextColor: '#555555',
        welcomeLogoTitleColor: '#0084AE',
        questionCardBg: 'linear-gradient(145deg, rgba(225, 225, 225, 0.9), rgba(210, 210, 210, 0.85))',
        questionTitleColor: '#333333',
        questionOptionTextColor: '#000000',
        finalPageSubtitleColor: '#333333',
        backTextColor: '#555'
    }
    };

    function applyCompanyTheme(company) {
        const normalizedCompany = (company || '').toLowerCase();
        let theme;
        document.body.className = '';
        if (normalizedCompany.includes('smj')) {
            theme = themes['SMJ'];
            document.body.classList.add('smj-theme-layout');
        } else if (normalizedCompany.includes('eb infinity')) {
            theme = themes['EB Infinity'];
            document.body.classList.add('eb-theme-layout');
        } else {
            theme = themes['AmongUs'];
        }
        companyConfig = theme;
        const root = document.documentElement;
        root.style.setProperty('--secondary-color', theme.secondaryColor);
        root.style.setProperty('--accent-color', theme.accentColor);
        root.style.setProperty('--accent-hover-color', theme.accentHoverColor);
        root.style.setProperty('--overlay-color', theme.overlayColor);
        root.style.setProperty('--selection-border-color', theme.selectionBorderColor);
        root.style.setProperty('--suggested-link-bg', theme.suggestedLinkBg);
        root.style.setProperty('--suggested-link-hover-bg', theme.suggestedLinkHoverBg);
        root.style.setProperty('--welcome-text-color', theme.welcomeTextColor);
        root.style.setProperty('--welcome-logo-title-color', theme.welcomeLogoTitleColor);
        root.style.setProperty('--question-card-bg', theme.questionCardBg);
        root.style.setProperty('--question-title-color', theme.questionTitleColor);
        root.style.setProperty('--question-option-text-color', theme.questionOptionTextColor);
        root.style.setProperty('--final-page-subtitle-color', theme.finalPageSubtitleColor);
        root.style.setProperty('--back-text-color', theme.backTextColor);
        const mainLogo = document.querySelector('.logo-icon');
        if (mainLogo) {
            mainLogo.src = theme.logo;
        }
    }
    let currentSortKey = 'date';
    let currentSortDirection = 'desc';

    async function initializeSurvey() {
        document.querySelector('.background-container').style.display = 'block';
        document.querySelector('.main-header').style.display = 'flex';
        mainContent.style.display = 'flex';
        adminPanelContainer.style.display = 'none';

        const urlParams = new URLSearchParams(window.location.search);
        surveyId = urlParams.get('s');
        const companyParam = urlParams.get('c');
        const parts = companyParam ? companyParam.split('-') : [];
        companyName = parts[0];
        const companyCode = parts[1];
        const themeData = themes[companyName];

        if (!themeData || companyCode !== themeData.code) {
            mainContent.innerHTML = `<p class="welcome-text">ACCESS DENIED.<br>Please use a valid survey link.</p>`;
            mainHeader.style.display = 'none';
            document.querySelector('.background-container').style.display = 'none';
            return;
        }

        const skipWelcome = urlParams.get('skipWelcome');
        const userName = urlParams.get('name');
        const userAge = urlParams.get('age');
        applyCompanyTheme(companyName);

        if (surveyId) {
            mainContent.innerHTML = '<p class="welcome-text loading-animation">Loading survey</p>';
            
            try {
                const data = await fetchApiData({ action: 'getInitialData', sheet: surveyId });

                if (data.error) {
                    throw new Error(data.error);
                }
                if (data.questions.error) {
                    mainContent.innerHTML = `<p class="welcome-text">Error: ${data.questions.error}. Please check the survey ID.</p>`;
                    return;
                }
                if (!data.questions || data.questions.length === 0) {
                    mainContent.innerHTML = `<p class="welcome-text">This survey currently has no questions.</p>`;
                    return;
                }
                
                surveyQuestions = data.questions;
                allSurveys = data.surveyNames;

                if (skipWelcome === 'true' && userName) {
                    userAnswers.name = decodeURIComponent(userName);
                    userAnswers.age = decodeURIComponent(userAge || 'N/A');
                    sessionStorage.setItem('surveyUserName', userAnswers.name);
                    sessionStorage.setItem('surveyUserAge', userAnswers.age);
                    startSurvey();
                } else {
                    renderWelcomePage();
                }
            } catch (error) {
                mainContent.innerHTML = `<p class="welcome-text">Could not load survey: ${error.message}. Please try again later.</p>`;
            }
        } else {
            mainContent.innerHTML = `<p class="welcome-text">No survey specified. Please use a valid survey link.</p>`;
        }
    }
    function renderWelcomePage() {
        mainHeader.style.opacity = '0';
        mainContent.innerHTML = `
            <div class="welcome-section">
                <div class="welcome-logo-container">
                    <img src="${companyConfig.logo}" alt="Large Logo" class="welcome-logo-icon">
                    <h1 class="welcome-logo-title">Survey</h1>
                </div>
                <p class="welcome-text">
                    Welcome, and thank you for your time. This short survey will only take a few moments to complete, and your valuable perspective is greatly appreciated by our team.
                </p>
                <div class="survey-form">
                    <div class="form-row">
                        <div class="input-group name-group">
                            <label for="name-input">Enter your name (optional)</label>
                            <input type="text" id="name-input" name="name" autocomplete="name" maxlength="20">
                        </div>
                        <div class="input-group age-group">
                            <label for="age-input">Age (optional)</label>
                            <input type="number" id="age-input" name="age" min="21" max="99">
                        </div>
                    </div>
                    <div class="button-group">
                        <button type="button" class="proceed-btn">Proceed to Survey</button>
                        <button type="button" class="anonymous-btn">Proceed Anonymously</button>
                    </div>
                </div>
            </div>
        `;
        document.querySelector('.proceed-btn').addEventListener('click', () => {
    const nameInput = document.getElementById('name-input');
    const ageInput = document.getElementById('age-input');

    if (nameInput.value.trim() === '') {
        showAlert('Please enter your name to proceed.');
        return;
    }
    userAnswers.name = nameInput.value.trim();
    userAnswers.age = ageInput.value.trim() || 'N/A';
    sessionStorage.setItem('surveyUserAge', userAnswers.age);
    sessionStorage.setItem('surveyUserName', userAnswers.name);
    
    startSurvey();
});
        document.querySelector('.anonymous-btn').addEventListener('click', () => {
            const ageInput = document.getElementById('age-input');
            const ageValue = ageInput.value.trim();

            userAnswers.name = 'Anonymous';
            userAnswers.age = ageValue === '' ? 'N/A' : ageValue;
            sessionStorage.setItem('surveyUserAge', userAnswers.age);
sessionStorage.setItem('surveyUserName', userAnswers.name);
            startSurvey();
        });
    }

    function startSurvey() {
        mainHeader.style.opacity = '1';
        mainContent.innerHTML = '';
        currentQuestionIndex = 0;
        renderQuestion();
    }

    function renderQuestion() {
        if (currentQuestionIndex >= surveyQuestions.length) {
            endSurvey();
            return;
        }
        const q = surveyQuestions[currentQuestionIndex];
        const backButtonHtml = currentQuestionIndex > 0 ? `<a href="#" class="back-text">← Back to Previous Question</a>` : '';

        let questionSpecificHtml = '';
        const starSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="m233-120 65-281L80-590l288-25 112-265 112 265 288 25-218 189 65 281-247-149-247 149Z"/></svg>`;

        if (q.type === 'rating_numbers') {
            questionSpecificHtml = `
                <div class="rating-user-container">
                    <span class="rating-number" data-value="1">1</span>
                    <span class="rating-number" data-value="2">2</span>
                    <span class="rating-number" data-value="3">3</span>
                    <span class="rating-number" data-value="4">4</span>
                    <span class="rating-number" data-value="5">5</span>
                </div>
            `;
        } else if (q.type === 'rating_stars') {
            questionSpecificHtml = `
                <div class="rating-user-container">
                    <span class="rating-star" data-value="1">${starSvg}</span>
                    <span class="rating-star" data-value="2">${starSvg}</span>
                    <span class="rating-star" data-value="3">${starSvg}</span>
                    <span class="rating-star" data-value="4">${starSvg}</span>
                    <span class="rating-star" data-value="5">${starSvg}</span>
                </div>
            `;
        } else if (!q.options || q.options.length === 0) {
            questionSpecificHtml = `<textarea class="textarea-input" placeholder="Type your answer here..."></textarea>`;
        } else {
            let optionsHtml = q.options.map(option => {
    const optionAsString = String(option);
    let displayValue = optionAsString;
    const hasTextField = optionAsString.includes('::textfield=true');

    if (hasTextField) {
        displayValue = displayValue.replace('::textfield=true', '');
    }
    if (displayValue.includes('::score=')) {
        displayValue = displayValue.split('::score=')[0];
    }
    
    displayValue = displayValue.replace(' (Please specify)', '').trim();

    if (hasTextField) {
        const optionContent = `
            <span>${displayValue}</span>
            <input type="text" class="other-input-inline" placeholder="Please specify...">
        `;
        return `<div class="question-option" data-value="${optionAsString}">${optionContent}</div>`;
    } else {
        return `<div class="question-option" data-value="${optionAsString}">${displayValue}</div>`;
    }
}).join('');
            questionSpecificHtml = `<div class="question-options">${optionsHtml}</div>`;
        }
        
        let progressBarHtml = '<div class="progress-bar-container">';
        for (let i = 0; i < surveyQuestions.length; i++) {
            const activeClass = i <= currentQuestionIndex ? 'active' : '';
            progressBarHtml += `<div class="progress-bar-segment ${activeClass}"></div>`;
        }
        progressBarHtml += '</div>';

        mainContent.innerHTML = `
            <div class="question-card slide-in-question">
                <h3 class="survey-title">${q.question}</h3>
                ${questionSpecificHtml}
                <div class="navigation-buttons">
                   <button class="next-btn">${currentQuestionIndex === surveyQuestions.length - 1 ? 'Submit' : 'Next Question'}</button>
                   ${backButtonHtml}
                </div>
                ${progressBarHtml}
            </div>
        `;
        setupQuestionListeners();
    }
    function handleBack() {
        if (currentQuestionIndex > 0) {
            const currentCard = document.querySelector('.question-card');
            if (currentCard) {
                currentCard.classList.add('slide-out-question-reverse');
                setTimeout(() => {
                    currentQuestionIndex--;
                    renderQuestion();
                    repopulateAnswer();
                }, 400); 
            }
        }
    }

    function repopulateAnswer() {
        const previousAnswer = userAnswers[`question-${currentQuestionIndex}`];
        if (!previousAnswer) return;

        const allAnswers = previousAnswer.split(', ');
        const options = document.querySelectorAll('.question-option');
        options.forEach(option => {
            if (allAnswers.some(ans => ans.startsWith(option.dataset.value))) {
                option.classList.add('selected');
                const inlineInput = option.querySelector('.other-input-inline');
                if (inlineInput) {
                    const specificAnswer = allAnswers.find(ans => ans.startsWith(option.dataset.value));
                    if (specificAnswer && specificAnswer.includes(': ')) {
                        inlineInput.value = specificAnswer.split(': ')[1];
                    }
                }
            }
        });

        const textarea = document.querySelector('.textarea-input');
        if (textarea && allAnswers.length > 0) {
            textarea.value = allAnswers[0];
        }
    }

function setupQuestionListeners() {
        const options = document.querySelectorAll('.question-option');
        const textarea = document.querySelector('.textarea-input');
        const ratingNumbers = document.querySelectorAll('.rating-number');
        const ratingStars = document.querySelectorAll('.rating-star');
        const q = surveyQuestions[currentQuestionIndex];

        options.forEach(option => {
            option.addEventListener('click', (e) => {
                if (e.target.tagName === 'INPUT') {
                    e.stopPropagation();
                    return;
                }
                if (q.type === 'multiple') {
                    option.classList.toggle('selected');
                } else {
                    options.forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                }
            });
        });

        ratingNumbers.forEach(num => {
            num.addEventListener('click', () => {
                ratingNumbers.forEach(n => n.classList.remove('selected'));
                num.classList.add('selected');
            });
        });

        ratingStars.forEach(star => {
            star.addEventListener('click', () => {
                const rating = parseInt(star.dataset.value, 10);
                ratingStars.forEach((s, i) => {
                    s.classList.toggle('selected', i < rating);
                });
            });
        });

        const backText = document.querySelector('.back-text');
        if (backText) {
            backText.addEventListener('click', (e) => {
                e.preventDefault();
                handleBack();
            });
        }

        document.querySelector('.next-btn').addEventListener('click', () => {
            let finalAnswers = [];
            const selectedOptions = document.querySelectorAll('.question-option.selected');
            const selectedNumber = document.querySelector('.rating-number.selected');
            const selectedStars = document.querySelectorAll('.rating-star.selected');

            if (textarea) {
                if (textarea.value.trim() !== '') {
                    finalAnswers.push(textarea.value.trim());
                }
            } else if (selectedOptions.length > 0) {
                selectedOptions.forEach(opt => {
    const baseValue = opt.dataset.value;
    const inlineInput = opt.querySelector('.other-input-inline');
    const displaySpan = opt.querySelector('span');
    const cleanDisplayText = displaySpan ? displaySpan.textContent : '';

    if (inlineInput && inlineInput.value.trim() !== '') {
        finalAnswers.push(`${cleanDisplayText}: ${inlineInput.value.trim()}`);
    } else {
        finalAnswers.push(baseValue);
    }
});
            } else if (selectedNumber) {
                finalAnswers.push(selectedNumber.dataset.value);
            } else if (selectedStars.length > 0) {
                finalAnswers.push(String(selectedStars.length));
            }


            if (finalAnswers.length === 0 && q.type !== 'paragraph') {
                showAlert('Please select an answer.');
                return;
            }

            const answerValue = finalAnswers.join('|||');

            userAnswers[`question-${currentQuestionIndex}`] = answerValue.trim();
            currentQuestionIndex++;

            const currentCard = document.querySelector('.question-card');
            if (currentCard) {
                currentCard.classList.add('slide-out-question');
                setTimeout(() => {
                    renderQuestion();
                }, 400);
            } else {
                renderQuestion();
            }
        });
    }
    function endSurvey() {
        const spinner = showSpinner('Saving your answers...');

        const responses = surveyQuestions.map((q, index) => {
            return userAnswers[`question-${index}`] || '';
        });

        const payload = {
            action: 'submitAnswers',
            sheet: surveyId,
            answers: {
                participant: userAnswers.name,
                age: userAnswers.age,
                company: companyName,
                responses: responses,
                timestamp: new Date().toLocaleString('en-US', { timeZone: 'America/New_York' })
            }
        };

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(payload),
            headers: {
                'Content-Type': 'text/plain;charset=utf-8',
            }
        }).then(res => res.json()).then(result => {
            hideSpinner(spinner);
            if (result.status === 'success') {
                renderFinalPage();
            } else {
                showAlert('Error saving answers: ' + result.message);
            }
        }).catch(err => {
            hideSpinner(spinner);
            if (err instanceof TypeError && err.message === 'Failed to fetch') {
                console.log("Submit answers request may have succeeded despite CORS error.");
                renderFinalPage();
            } else {
                showAlert('An unexpected network error occurred while saving answers.');
            }
        });
    }

    function renderFinalPage() {
        mainHeader.style.opacity = '0';
        const thankYouMessage = userAnswers.name === 'Anonymous' ? 'Thank you!' : `Thank you, ${userAnswers.name}!`;
        let suggestedLinksHtml = '<p>No other surveys available at the moment.</p>';
        const otherSurveys = allSurveys.filter(s => s.id !== surveyId);
        if (otherSurveys.length > 0) {
const finalUserName = sessionStorage.getItem('surveyUserName') || userAnswers.name || 'Anonymous';
const finalUserAge = sessionStorage.getItem('surveyUserAge') || userAnswers.age || '';

const userNameForLink = encodeURIComponent(finalUserName);
const userAgeForLink = encodeURIComponent(finalUserAge);
            suggestedLinksHtml = otherSurveys.map(s => `<a href="?s=${s.id}&c=${companyName}-${themes[companyName].code}&skipWelcome=true&name=${userNameForLink}&age=${userAgeForLink}" class="survey-link">${s.name}</a>`).join('');
        }

        mainContent.innerHTML = `
            <div class="final-page">
                <h2>${thankYouMessage}</h2>
                <p>Your feedback is highly valuable and has been recorded.</p>
                <div class="suggested-surveys">
                    <h3>Suggested Surveys</h3>
                    <div class="survey-links-container">
                        ${suggestedLinksHtml}
                    </div>
                </div>
            </div>
        `;
    }

    function showAlert(message) {
    const existingModal = document.querySelector('.alert-modal');
    if(existingModal) existingModal.remove();
    const alertModal = document.createElement('div');
    
    const isAdminView = document.getElementById('admin-panel-container').style.display === 'flex';
    if (isAdminView) {
        alertModal.classList.add('alert-modal');
    } else {
        alertModal.classList.add('alert-modal', 'survey-alert');
    }

    alertModal.innerHTML = `<p>${message}</p><button>OK</button>`;
    document.body.appendChild(alertModal);
    alertModal.querySelector('button').addEventListener('click', () => {
        alertModal.remove();
    });
}
function showDeleteConfirmationModal(message, onConfirmSingle, onConfirmAll) {
    const existingModal = document.querySelector('.alert-modal');
    if(existingModal) existingModal.remove();

    const alertModal = document.createElement('div');
    alertModal.classList.add('alert-modal');

    alertModal.innerHTML = `
        <p>${message}</p>
        <div class="alert-modal-actions">
            <button id="confirm-single-btn">Delete Just This One</button>
            <button id="confirm-all-btn" class="delete-all-btn">Delete All Duplicates</button>
            <button id="cancel-btn" class="cancel-btn">Cancel</button>
        </div>
    `;

    document.body.appendChild(alertModal);

    const close = () => alertModal.remove();

    alertModal.querySelector('#confirm-single-btn').addEventListener('click', () => {
        close();
        onConfirmSingle();
    });

    alertModal.querySelector('#confirm-all-btn').addEventListener('click', () => {
        close();
        onConfirmAll();
    });

    alertModal.querySelector('#cancel-btn').addEventListener('click', () => {
        close();
    });
}

function deleteSingleParticipant(timestamp, survey, participantName) {
    const participantIndex = adminDataCache.statsData.allParticipants.findIndex(p => p.date === timestamp && p.survey === survey);
    if (participantIndex === -1) return;

    const participantToRemove = adminDataCache.statsData.allParticipants[participantIndex];
    adminDataCache.statsData.allParticipants.splice(participantIndex, 1);
    refreshAdminStatsView(); // ISPRAVKA

    const spinner = showAdminSpinner();

    const handleSuccess = () => {
        hideAdminSpinner(spinner);
        showAlert('Participant response deleted successfully.');
    };

    const handleError = (errorMsg) => {
        hideAdminSpinner(spinner);
        adminDataCache.statsData.allParticipants.splice(participantIndex, 0, participantToRemove);
        refreshAdminStatsView(); // ISPRAVKA
        showAlert(errorMsg);
    };

    fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'deleteParticipant', surveyName: survey, timestamp: timestamp }),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    })
    .then(res => res.json())
    .then(result => {
        if (result && result.status === 'success') handleSuccess();
        else handleError('Error deleting response: ' + (result ? result.message : 'Unknown error'));
    })
    .catch(err => {
        if (err instanceof TypeError && err.message === 'Failed to fetch') handleSuccess(); 
        else handleError('An unexpected network error occurred: ' + err.message);
    });
}

function deleteAllDuplicates(baseTimestamp, surveyName) {
    // 1. Pronalazi SVE unose koji su označeni kao duplikati u celokupnom setu podataka
    const duplicateTimestamps = findDuplicates(adminDataCache.statsData.allParticipants);

    if (duplicateTimestamps.size === 0) {
        showAlert('No entries are currently marked as duplicates.');
        return;
    }

    // 2. Kreira listu svih objekata koje treba obrisati
    const duplicatesToDelete = adminDataCache.statsData.allParticipants.filter(p => duplicateTimestamps.has(p.date));
    
    const originalCache = [...adminDataCache.statsData.allParticipants];
    const timestampsToDelete = Array.from(duplicateTimestamps);
    
    // 3. Ažurira prikaz na stranici
    adminDataCache.statsData.allParticipants = adminDataCache.statsData.allParticipants.filter(p => !timestampsToDelete.includes(p.date));
    refreshAdminStatsView();

    const spinner = showAdminSpinner();
    // 4. Priprema podatke za slanje Google Script-u
    const deletePayload = duplicatesToDelete.map(p => ({ surveyName: p.survey, timestamp: p.date }));

    const handleSuccess = () => {
        hideAdminSpinner(spinner);
       showAlert(`${deletePayload.length} marked duplicate(s) deleted successfully.`);
    };

    const handleError = (errorMsg) => {
        hideAdminSpinner(spinner);
        adminDataCache.statsData.allParticipants = originalCache; // Vraća na staro
        refreshAdminStatsView();
        showAlert(errorMsg);
    };
    
    fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'deleteMultipleParticipants', data: deletePayload }),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    })
    .then(res => res.json())
    .then(result => {
        if (result && result.status === 'success') handleSuccess();
        else handleError('Error deleting duplicates: ' + (result ? result.message : 'Unknown error'));
    })
    .catch(err => {
        if (err instanceof TypeError && err.message === 'Failed to fetch') handleSuccess();
        else handleError('An unexpected network error occurred: ' + err.message);
    });
}

function findDuplicates(participants) {
        const sortedParticipants = [...participants].sort((a, b) => new Date(a.date) - new Date(b.date));
        const duplicates = new Set();
        const FORTY_MINUTES = 40 * 60 * 1000;

        for (let i = 0; i < sortedParticipants.length; i++) {
            for (let j = i + 1; j < sortedParticipants.length; j++) {
                const p1 = sortedParticipants[i];
                const p2 = sortedParticipants[j];

                const timeDiff = new Date(p2.date) - new Date(p1.date);

                if (timeDiff > FORTY_MINUTES) {
                    break;
                }

                if (p1.participant === p2.participant &&
                    p1.age === p2.age &&
                    p1.company === p2.company &&
                    p1.survey === p2.survey &&
                    JSON.stringify(p1.responses) === JSON.stringify(p2.responses)) {
                    duplicates.add(p2.date);
                }
            }
        }
        return duplicates;
    }
    function showSpinner(text = 'Please wait...') {
    const spinner = document.createElement('div');

    const isAdminView = document.getElementById('admin-panel-container').style.display === 'flex';
    if (isAdminView) {
        spinner.className = 'alert-modal';
    } else {
        spinner.className = 'alert-modal survey-alert';
    }

    spinner.innerHTML = `<p class="loading-animation">${text}</p>`;
    document.body.appendChild(spinner);
    return spinner;
}

    function hideSpinner(spinner) {
        if(spinner) spinner.remove();
    }

    function showAdminSpinner() {
    const existingSpinner = document.querySelector('.spinner-overlay');
    if (existingSpinner) existingSpinner.remove();

    const overlay = document.createElement('div');
    overlay.className = 'spinner-overlay';
    overlay.innerHTML = '<div class="custom-spinner"></div>';
    document.body.appendChild(overlay);

    setTimeout(() => {
        overlay.classList.add('visible');
    }, 10);

    return overlay;
}

function hideAdminSpinner(spinnerElement) {
    if (spinnerElement && spinnerElement.classList.contains('spinner-overlay')) {
        spinnerElement.classList.remove('visible');
        spinnerElement.addEventListener('transitionend', () => {
            if (spinnerElement.parentNode) {
                spinnerElement.parentNode.removeChild(spinnerElement);
            }
        }, { once: true });
    }
}
function showInitialAdminLoader() {
    const existingLoader = document.querySelector('#initial-admin-loader');
    if (existingLoader) existingLoader.remove();

    const overlay = document.createElement('div');
    overlay.id = 'initial-admin-loader';
    overlay.className = 'initial-admin-loader-overlay';
    overlay.innerHTML = `
        <div class="loader-content">
            <svg xmlns="http://www.w3.org/2000/svg" height="80" viewBox="0 -960 960 960" width="80" fill="currentColor"><path d="M120-240v-240h320v240H120Zm0-320v-240h320v240H120Zm400 320v-240h320v240H520Zm0-320v-240h320v240H520Z"/></svg>
            <h2>Admin Panel</h2>
        </div>
    `;
    document.body.appendChild(overlay);

    setTimeout(() => {
        overlay.classList.add('visible');
    }, 10);
    return overlay;
}

function hideInitialAdminLoader(loaderElement) {
    if (loaderElement) {
        loaderElement.classList.remove('visible');
        loaderElement.addEventListener('transitionend', () => loaderElement.remove(), { once: true });
    }
}
function checkAdminAccess() {
        const ADMIN_ACCESS_KEY = 'dM456ad3n9';

        const urlParams = new URLSearchParams(window.location.search);
        const providedKey = urlParams.get('access-key');

        if (providedKey === ADMIN_ACCESS_KEY) {
            initAdmin();
        }
    }

    function initAdmin() {
    document.querySelector('.background-container').style.display = 'none';
    document.querySelector('.main-header').style.display = 'none';
    mainContent.style.display = 'none';
    adminPanelContainer.style.display = 'flex';
    
    const loader = showInitialAdminLoader();

    
    fetchAllAdminDataInPromise().then(newData => {
        
        console.log('SURVEYS RECEIVED FROM SERVER:', newData.surveyNames);
        const oldDataString = localStorage.getItem('adminLastKnownState');
        const oldData = oldDataString ? JSON.parse(oldDataString) : null;

       
        if (oldData) {
            compareAndNotify(newData, oldData, 'welcome'); 
        }

       
        localStorage.setItem('adminLastKnownState', JSON.stringify(newData));
        
       
        adminDataCache = newData;

       
        hideInitialAdminLoader(loader);
        renderAdminMainMenu();
        startBackgroundRefresh(); 

    }).catch(error => {
        hideInitialAdminLoader(loader);
        showAlert('Failed to load initial admin data: ' + error);
        renderAdminMainMenu();
    });
}
    function startBackgroundRefresh() {
    if (cacheIntervalId) {
        clearInterval(cacheIntervalId);
    }
    cacheIntervalId = setInterval(() => {
        refreshDataInBackground();
    }, 10 * 60 * 1000);
}



function refreshDataInBackground() {
    fetchAllAdminDataInPromise().then(latestData => {
        if (adminDataCache) {
            compareAndNotify(latestData, adminDataCache, 'live'); 
        }
        adminDataCache = latestData;
        localStorage.setItem('adminLastKnownState', JSON.stringify(latestData));

    }).catch(error => {
        console.error("Background refresh failed:", error);
    });
}

    function renderAdminMainMenu() {
        adminPanelContainer.innerHTML = `
            <div class="admin-panel-title">
                <svg xmlns="http://www.w3.org/2000/svg" height="40" viewBox="0 -960 960 960" width="40" fill="currentColor"><path d="M120-240v-240h320v240H120Zm0-320v-240h320v240H120Zm400 320v-240h320v240H520Zm0-320v-240h320v240H520Z"/></svg>
                <span>Admin Panel</span>
            </div>
            <div class="admin-main-menu">
                <div class="admin-card" id="add-survey-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                    <h2>Add Survey</h2>
                </div>
                <div class="admin-card" id="edit-survey-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                    <h2>Edit Surveys</h2>
                </div>
                <div class="admin-card" id="stats-survey-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 9.2h3V19H5zM10.6 5h2.8v14h-2.8zm5.6 8H19v6h-2.8z"/></svg>
                    <h2>Statistics</h2>
                </div>
            </div>
        `;
        document.getElementById('add-survey-btn').addEventListener('click', () => renderAddOrEditSurveyForm());
        document.getElementById('edit-survey-btn').addEventListener('click', () => renderSurveyList('edit'));
        document.getElementById('stats-survey-btn').addEventListener('click', () => renderStatisticsDashboard());

    }
   function renderAddOrEditSurveyForm(surveyData = null) {
        const isEditMode = surveyData !== null;
        const originalSurveyName = isEditMode ? surveyData.name : '';
        const title = isEditMode ? 'Edit Survey' : 'Add New Survey';
        const saveButtonText = isEditMode ? 'Apply Changes' : 'Save Survey';
        let questionsHtml = '';
        if (isEditMode && surveyData.questions) {
            surveyData.questions.forEach((q, index) => {
                questionsHtml += generateQuestionBlock(index, q, isEditMode);
            });
        } else {
            questionsHtml = generateQuestionBlock(0, {}, isEditMode);
        }
        const tooltipText = `INSTRUCTIONS:\n\n- Scoring (1-5): Assigns a numerical value to an answer, useful for later analysis and statistics.\n\n- Text Input: To allow users to type a custom response next to an option, add '(please explain)' to the answer text.`;
        adminPanelContainer.innerHTML = `
            <div class="admin-page-content">
                <a href="#" class="admin-back-button" style="display: flex; align-items: center; gap: 5px;">
                    <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20" fill="currentColor"><path d="M400-80 0-480l400-400 56 57-343 343 343 343-56 57Z"/></svg>
                    <span>${isEditMode ? 'Back to Survey List' : 'Back to Admin Panel'}</span>
                </a>
                <h1 style="display: flex; align-items: center; justify-content: center; gap: 15px;">
    <svg xmlns="http://www.w3.org/2000/svg" height="32" viewBox="0 0 24 24" width="32" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
    <span>${title}</span>
</h1>
                <div id="survey-form-admin">
                    <div class="admin-form-group">
                        <label for="survey-name">Survey Name</label>
                        <input type="text" id="survey-name" class="admin-input" placeholder="Enter the name of the survey" value="${originalSurveyName}">
                    </div>
                    <div id="questions-container">
                        ${questionsHtml}
                        <button class="add-question-btn-main">
    <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20" fill="currentColor"><path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z"/></svg>
    Add Question
</button>
                    </div>
                </div>
                <div class="admin-form-footer">
                    <button id="save-survey-btn" class="admin-button save-btn">${saveButtonText}</button>
                </div>
            </div>
        `;

        const questionsContainer = document.getElementById('questions-container');
        if (isEditMode && questionsContainer.innerHTML.trim() === '') {
            questionsContainer.innerHTML = `
                <button class="add-question-btn-main" style="margin: 0 auto;">
                    <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20" fill="currentColor"><path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z"/></svg>
                    Add Question
                </button>
            `;
        }

        document.querySelector('.admin-back-button').addEventListener('click', (e) => {
    e.preventDefault();
    if (isEditMode) {
        renderSurveyList('edit');
    } else {
        renderAdminMainMenu();
    }
});

adminPanelContainer.querySelector('.admin-page-content').addEventListener('change', function(e) {
            if (e.target.matches('select[name="question-type"]')) {
                const select = e.target;
                const questionBlock = select.closest('.admin-question-block');
                const answersContainer = questionBlock.querySelector('.question-answers');
                const paragraphContainer = questionBlock.querySelector('.paragraph-answer-container');
                const numbersPreview = questionBlock.querySelector('.numbers-preview');
                const starsPreview = questionBlock.querySelector('.stars-preview');
                
                answersContainer.classList.add('hidden');
                paragraphContainer.classList.add('hidden');
                numbersPreview.classList.add('hidden');
                starsPreview.classList.add('hidden');

                if (select.value === 'paragraph') {
                    paragraphContainer.classList.remove('hidden');
                } else if (select.value === 'rating_numbers') {
                    numbersPreview.classList.remove('hidden');
                } else if (select.value === 'rating_stars') {
                    starsPreview.classList.remove('hidden');
                } else { 
                    answersContainer.classList.remove('hidden');
                }
            }
        });

    
        adminPanelContainer.querySelector('.admin-page-content').addEventListener('click', function(e) {
           const toggleIcon = e.target.closest('.textfield-toggle-icon');
if (toggleIcon && !toggleIcon.classList.contains('permanent')) {
    e.preventDefault();
    toggleIcon.classList.toggle('enabled');
    const tooltip = toggleIcon.querySelector('.tooltip');
    if (tooltip) {
        tooltip.textContent = toggleIcon.classList.contains('enabled') 
            ? 'Disable text input for user' 
            : 'Enable text input for user';
    }

    const answerGroup = toggleIcon.closest('.admin-answer-group');
    const textInput = answerGroup.querySelector('.answer-text-input');
    const specifyText = ' (Please specify)';

    if (toggleIcon.classList.contains('enabled')) {
        if (!textInput.value.includes(specifyText)) {
            textInput.value = textInput.value.trim() + specifyText;
        }
    } else {
        if (textInput.value.endsWith(specifyText)) {
            textInput.value = textInput.value.slice(0, -specifyText.length).trim();
        }
    }
}
            if (e.target.closest('.add-question-btn-main')) {
                e.preventDefault();

                const allQuestionInputs = document.querySelectorAll('input[name="question-text"]');
                if (allQuestionInputs.length > 0) {
                    validateInput(allQuestionInputs[allQuestionInputs.length - 1]);
                }

                const newIndex = document.querySelectorAll('.question-block-wrapper').length;
                const newQuestionHtml = generateQuestionBlock(newIndex, {}, isEditMode);
                const button = e.target.closest('.add-question-btn-main');
                button.insertAdjacentHTML('beforebegin', newQuestionHtml);
            }
            if (e.target.closest('.add-answer-btn')) {
                e.preventDefault();
                const addAnswerButton = e.target.closest('.add-answer-btn');
                const answersContainer = addAnswerButton.parentElement.parentElement;
                
                const allAnswerInputs = answersContainer.querySelectorAll('.answer-text-input');
                if (allAnswerInputs.length > 0) {
                    validateInput(allAnswerInputs[allAnswerInputs.length - 1]);
                }

                answersContainer.insertBefore(generateAnswerInput(), addAnswerButton.parentElement);
            } else if (e.target.closest('.add-other-btn')) {
    e.preventDefault();
    const addOtherButton = e.target.closest('.add-other-btn');
    const answersContainer = addOtherButton.parentElement.parentElement;
    const allAnswerInputs = answersContainer.querySelectorAll('.answer-text-input');
    if (allAnswerInputs.length > 0) {
        validateInput(allAnswerInputs[allAnswerInputs.length - 1]);
    }
    answersContainer.insertBefore(generateAnswerInput('Other::textfield=true'), addOtherButton.parentElement);
}
            if (e.target.closest('.delete-question-btn-wrapper')) {
                e.preventDefault();
                const wrapperToDelete = e.target.closest('.delete-question-btn-wrapper').parentElement;
                if (isEditMode) {
                    const buttonToDelete = wrapperToDelete.nextElementSibling;
                    wrapperToDelete.remove();
                    if (buttonToDelete && buttonToDelete.matches('.add-question-btn-main')) {
                        buttonToDelete.remove();
                    }
                    const questionsContainer = document.getElementById('questions-container');
                    const lastElement = questionsContainer.lastElementChild;
                    if (!lastElement || lastElement.matches('.question-block-wrapper')) {
                        const addButtonHtml = `
                            <button class="add-question-btn-main" style="margin: -10px auto 30px auto;">
                                <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20" fill="currentColor"><path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z"/></svg>
                                Add Question
                            </button>
                        `;
                        questionsContainer.insertAdjacentHTML('beforeend', addButtonHtml);
                    }
                } else {
                    wrapperToDelete.remove();
                }
            }
            if (e.target.closest('.delete-answer-btn')) {
                e.preventDefault();
                e.target.closest('.admin-answer-group').remove();
            }
            if (e.target.closest('.toggle-answers-btn')) {
                e.preventDefault();
                const toggleBtn = e.target.closest('.toggle-answers-btn');
                const questionBlock = e.target.closest('.admin-question-block');
                const answersContainer = questionBlock.querySelector('.question-answers');
const paragraphContainer = questionBlock.querySelector('.paragraph-answer-container');
const numbersPreview = questionBlock.querySelector('.numbers-preview');
const starsPreview = questionBlock.querySelector('.stars-preview');

if (answersContainer) answersContainer.classList.toggle('collapsed');
if (paragraphContainer) paragraphContainer.classList.toggle('collapsed');
if (numbersPreview) numbersPreview.classList.toggle('collapsed');
if (starsPreview) starsPreview.classList.toggle('collapsed');

toggleBtn.classList.toggle('collapsed');
questionBlock.classList.toggle('collapsed');
            }
        });
        
        let draggedItem = null;

questionsContainer.addEventListener('dragstart', (e) => {

    if (e.target.classList.contains('drag-handle')) {
        draggedItem = e.target.closest('.question-block-wrapper');
        
        setTimeout(() => {
            if(draggedItem) draggedItem.classList.add('dragging');
        }, 0);
        
        e.dataTransfer.effectAllowed = 'move';
    } else {
        e.preventDefault();
    }
});

questionsContainer.addEventListener('dragend', () => {
    if (draggedItem) {
        draggedItem.classList.remove('dragging');
        draggedItem = null;
    }
});

questionsContainer.addEventListener('dragover', (e) => {
    e.preventDefault(); 
    if (!draggedItem) return;
    const container = questionsContainer;
    const containerRect = container.getBoundingClientRect();
    const scrollZoneHeight = 60; 
    const scrollSpeed = 10; 


    if (e.clientY < containerRect.top + scrollZoneHeight) {
        container.scrollTop -= scrollSpeed;
    } 
    else if (e.clientY > containerRect.bottom - scrollZoneHeight) {
        container.scrollTop += scrollSpeed;
    }

    const afterElement = getDragAfterElement(container, e.clientY);
    
    if (afterElement == null) {
        container.insertBefore(draggedItem, container.querySelector('.add-question-btn-main'));
    } else {
        container.insertBefore(draggedItem, afterElement);
    }
});

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.question-block-wrapper:not(.dragging)')];
    
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

questionsContainer.addEventListener('drop', (e) => {
    e.preventDefault();
    if (!draggedItem) return;
    draggedItem.classList.remove('dragging');
    draggedItem = null;
});
        const formContent = adminPanelContainer.querySelector('.admin-page-content');

       function clearValidationError(inputElement) {
            if (!inputElement) return;
            inputElement.classList.remove('input-error');
            const wrapper = inputElement.closest('.admin-form-group') || inputElement.closest('.question-text-group') || inputElement.closest('.answer-input-wrapper');
            const nextEl = wrapper ? wrapper.nextElementSibling : null;
            if (nextEl && nextEl.classList.contains('error-message')) {
                nextEl.remove();
            }
        }

        function validateInput(input) {
            if (!input) return;

            const questionBlock = input.closest('.admin-question-block');
            const questionTypeSelect = questionBlock ? questionBlock.querySelector('select[name="question-type"]') : null;
            const typesWithoutAnswers = ['paragraph', 'rating_numbers', 'rating_stars'];
            if (input.matches('.answer-text-input') && questionTypeSelect && typesWithoutAnswers.includes(questionTypeSelect.value)) {
                clearValidationError(input);
                return;
            }

            if (input.value.trim() === '') {
                input.classList.add('input-error');
                const wrapper = input.closest('.admin-form-group') || input.closest('.question-text-group') || input.closest('.answer-input-wrapper');
                if (wrapper && (!wrapper.nextElementSibling || !wrapper.nextElementSibling.classList.contains('error-message'))) {
                    const errorSpan = document.createElement('span');
                    errorSpan.className = 'error-message';
                    errorSpan.textContent = 'This field cannot be empty.';
                    wrapper.parentNode.insertBefore(errorSpan, wrapper.nextSibling);
                }
            } else {
                clearValidationError(input);
            }
        }

        formContent.addEventListener('focusout', function(e) {
            if (e.target.matches('#survey-name, input[name="question-text"], .answer-text-input')) {
                validateInput(e.target);
            }
        });

        formContent.addEventListener('input', function(e) {
            const input = e.target;
            if (input.matches('#survey-name, input[name="question-text"], .answer-text-input')) {
                if (input.classList.contains('input-error')) {
                    clearValidationError(input);
                }
            }
        });

        document.getElementById('save-survey-btn').addEventListener('click', () => {
            let hasErrors = false;
            document.querySelectorAll('#survey-name, input[name="question-text"], .answer-text-input').forEach(input => {
                validateInput(input);
                if (input.classList.contains('input-error')) {
                    hasErrors = true;
                }
            });

            if (hasErrors) {
                showAlert('Please fill in all required fields.');
                const firstError = document.querySelector('.input-error');
                if (firstError) firstError.focus();
                return;
            }

            const newSurveyName = document.getElementById('survey-name').value.trim();
            if (!newSurveyName) {
                showAlert('Please enter a survey name.');
                return;
            }
            const questions = [];
            document.querySelectorAll('.admin-question-block').forEach(block => {
                const questionText = block.querySelector('input[name="question-text"]').value.trim();
                const questionType = block.querySelector('select[name="question-type"]').value;
                const answers = [];
                
                if (questionType !== 'paragraph' && questionType !== 'rating_numbers' && questionType !== 'rating_stars') {
                    block.querySelectorAll('.admin-answer-group').forEach(answerGroup => {
                        const answerTextInput = answerGroup.querySelector('input[name="answer-text"]');
                        const answerScoreSelect = answerGroup.querySelector('select[name="answer-score"]');
                        const isTextfieldEnabled = answerGroup.querySelector('.textfield-toggle-icon.enabled'); 
                        
                        const answerText = answerTextInput.value.trim();
                        const answerScore = answerScoreSelect.value;

                        if (answerText) {
                            let finalAnswerString = answerText;
                            if (answerScore !== '-') {
                                finalAnswerString += `::score=${answerScore}`;
                            }
                            if (isTextfieldEnabled) { 
                                finalAnswerString += '::textfield=true';
                            }
                            answers.push(finalAnswerString);
                        }
                    });
                }

                if (questionText) {
                    questions.push({ question: questionText, type: questionType, options: answers });
                }
            });
            if (questions.length === 0) {
                showAlert('Please add at least one question.');
                return;
            }
            const data = isEditMode ? { id: surveyData.id, newName: newSurveyName, questions: questions } : { name: newSurveyName, questions: questions };
            const action = isEditMode ? 'updateSurvey' : 'saveNewSurvey';
            const spinner = showAdminSpinner();

            const handleSuccess = (message) => {
    fetchApiData({ action: 'getSurveyNames' }).then(newNames => { 
        if (adminDataCache) {
            adminDataCache.surveyNames = newNames;
        }
    }).finally(() => {
                    hideAdminSpinner(spinner);
                    showAlert(message);
                    if (isEditMode) {
                        renderSurveyList('edit');
                    } else {
                        renderAdminMainMenu();
                    }
                });
            };

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: action, data: data }),
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8',
                }
            }).then(res => res.json()).then(result => {
                if (result.status === 'success') {
                    handleSuccess(result.message || 'Survey saved successfully!');
                } else {
                    hideAdminSpinner(spinner);
                    showAlert('Error: ' + (result.message || 'An unknown error occurred on the server.'));
                }
            }).catch(err => {
                if (err instanceof TypeError && err.message === 'Failed to fetch') {
                    handleSuccess('Survey data sent successfully. The change should be saved.');
                } else {
                    hideAdminSpinner(spinner);
                    showAlert('An unexpected error occurred: ' + err.message);
                }
            });
        });
if (!document.getElementById('custom-tooltip')) {
    const tooltipEl = document.createElement('div');
    tooltipEl.id = 'custom-tooltip';
    document.body.appendChild(tooltipEl);
}
const tooltip = document.getElementById('custom-tooltip');
const formContainer = document.getElementById('survey-form-admin');

const handleMouseOver = e => {
    if (e.target.classList.contains('has-tooltip')) {
        const text = e.target.getAttribute('data-tooltip');
        if (text) {
            tooltip.textContent = text;
            tooltip.style.display = 'block';

            const rect = e.target.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();

            let top = rect.top - tooltipRect.height - 8; 
            let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);

            if (top < 0) {
                top = rect.bottom + 8;
            }
            
            if (left < 10) left = 10;
            if (left + tooltipRect.width > window.innerWidth) {
                left = window.innerWidth - tooltipRect.width - 10;
            }

            tooltip.style.top = `${top}px`;
            tooltip.style.left = `${left}px`;
            tooltip.style.opacity = '1';
        }
    }
};

const handleMouseOut = e => {
    if (e.target.classList.contains('has-tooltip')) {
        tooltip.style.opacity = '0';
        tooltip.style.display = 'none';
    }
};

formContainer.removeEventListener('mouseover', handleMouseOver);
formContainer.removeEventListener('mouseout', handleMouseOut);
formContainer.addEventListener('mouseover', handleMouseOver);
formContainer.addEventListener('mouseout', handleMouseOut);
    }
function generateQuestionBlock(index, data = {}, isEditMode = false) {
    let answersHtml = '';
    if (data.options && data.options.length > 0) {
        data.options.forEach(opt => {
            answersHtml += generateAnswerInput(opt).outerHTML;
        });
    } else {
        answersHtml = generateAnswerInput('').outerHTML;
    }

    const isParagraph = data.type === 'paragraph';
    const isRatingNumbers = data.type === 'rating_numbers';
    const isRatingStars = data.type === 'rating_stars';
    
    const answersHiddenClass = (isParagraph || isRatingNumbers || isRatingStars) ? 'hidden' : '';
    const answersCollapsedClass = isEditMode ? 'collapsed' : '';
    const paragraphHiddenClass = !isParagraph ? 'hidden' : '';
    const ratingNumbersHiddenClass = !isRatingNumbers ? 'hidden' : '';
    const ratingStarsHiddenClass = !isRatingStars ? 'hidden' : '';

    const collapsedClass = isEditMode ? 'collapsed' : '';

    const starSvg = `<svg xmlns="http://www.w.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24"><path d="m233-120 65-281L80-590l288-25 112-265 112 265 288 25-218 189 65 281-247-149-247 149Z"/></svg>`;

    return `
        <div class="question-block-wrapper">
            <div class="admin-question-block ${collapsedClass}" data-index="${index}">
                <div class="question-header">
                    <img src="https://www.svgrepo.com/show/340221/draggable.svg" class="drag-handle" draggable="true" title="Drag to reorder">
                    <div class="toggle-answers-btn ${collapsedClass}" title="Show/Hide Answers">
                         <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="currentColor"><path d="M480-345 240-585l56-56 184 184 184-184 56 56-240 240Z"/></svg>
                    </div>
                    
                    <div class="admin-form-group question-text-group">
                        <input type="text" name="question-text" class="admin-input" placeholder="Enter question text" value="${data.question || ''}">
                    </div>
                    
                    <div class="admin-form-group question-type-group">
                        <select name="question-type" class="admin-select">
                            <option value="single" ${data.type === 'single' ? 'selected' : ''}>Single Choice</option>
                            <option value="multiple" ${data.type === 'multiple' ? 'selected' : ''}>Multiple Choice</option>
                            <option value="paragraph" ${isParagraph ? 'selected' : ''}>Paragraph</option>
                            <option value="rating_numbers" ${isRatingNumbers ? 'selected' : ''}>Rating (1-5)</option>
                            <option value="rating_stars" ${isRatingStars ? 'selected' : ''}>Rating (&#x2B50;)</option>
                        </select>
                    </div>
                </div>
                <div class="question-answers ${answersHiddenClass} ${answersCollapsedClass}">
                    ${answersHtml}
                    <div style="display: flex; align-items: center; gap: 15px; margin-top: 15px;">
                        <a href="#" class="add-answer-btn" style="color: #fff; text-decoration: none; display: inline-flex; align-items: center; gap: 5px; font-size: 0.9rem;">
    <svg xmlns="http://www.w3.org/2000/svg" height="18" viewBox="0 -960 960 960" width="18" fill="currentColor"><path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z"/></svg>
    add Answer
</a>
                        </a>
                        <span style="color: #ccc;">or</span>
                        <a href="#" class="add-other-btn" style="color: #00aaff; text-decoration: none; font-weight: bold; font-size: 0.9rem;">add "Other"</a>
                    </div>
                </div>
                <div class="paragraph-answer-container ${paragraphHiddenClass} ${answersCollapsedClass}">
                    <textarea class="admin-textarea" readonly placeholder="Users will enter their answer here. No additional options are needed."></textarea>
                </div>
                <div class="rating-preview-container numbers-preview ${ratingNumbersHiddenClass} ${answersCollapsedClass}">
                    <span class="rating-preview-item">1</span>
                    <span class="rating-preview-item">2</span>
                    <span class="rating-preview-item">3</span>
                    <span class="rating-preview-item">4</span>
                    <span class="rating-preview-item">5</span>
                </div>
                <div class="rating-preview-container stars-preview ${ratingStarsHiddenClass} ${answersCollapsedClass}">
                    <span class="rating-preview-star">${starSvg}</span>
                    <span class="rating-preview-star">${starSvg}</span>
                    <span class="rating-preview-star">${starSvg}</span>
                    <span class="rating-preview-star">${starSvg}</span>
                    <span class="rating-preview-star">${starSvg}</span>
                </div>
            </div>
            <div class="delete-question-btn-wrapper" title="Delete Question">
                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="currentColor"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg>
            </div>
        </div>
        `;
}
    function generateAnswerInput(value = '') {
    let text = value;
    let score = '-';
    let isTextfieldEnabled = false;

    if (text.includes('::textfield=true')) {
        isTextfieldEnabled = true;
        text = text.replace('::textfield=true', '');
    }
    if (text.includes('::score=')) {
        const parts = text.split('::score=');
        text = parts[0];
        score = parts[1];
    }

    const isOtherField = (text === 'Other' && isTextfieldEnabled);
    const readonlyAttr = isOtherField ? 'readonly' : '';
    const permanentIconClass = isOtherField ? 'permanent' : '';

    const div = document.createElement('div');
    div.className = 'admin-answer-group';

    const scoreOptions = ['-', '1', '2', '3', '4', '5'].map(s =>
        `<option value="${s}" ${s === score ? 'selected' : ''}>${s}</option>`
    ).join('');

    const enabledClass = isTextfieldEnabled ? 'enabled' : '';

    div.innerHTML = `
        <div class="answer-input-wrapper">
            <input type="text" name="answer-text" class="admin-input answer-text-input" placeholder="Enter answer option" value="${text}" ${readonlyAttr}>
            <span class="textfield-toggle-icon ${enabledClass} ${permanentIconClass}">
             <span class="icon-with-tooltip-wrapper">
                <img src="https://cdn-icons-png.freepik.com/256/14359/14359891.png?semt=ais_white_label" alt="Enable Text Input">
                <span class="tooltip">${isOtherField ? "Text input cannot be disabled for the 'Other' option." : (enabledClass ? 'Disable text input for user' : 'Enable text input for user')}</span>
            </span>
            </span>
        </div>
        <select name="answer-score" class="admin-select answer-score-select has-tooltip" data-tooltip="Assign a numerical score (1-5) to this answer for statistical analysis. Leave as '-' for no score.">
            ${scoreOptions}
        </select>
        <span class="delete-answer-btn" title="Delete Answer" style="cursor: pointer; color: #ccc; padding: 5px; transition: color 0.2s ease;">
            <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20" fill="currentColor"><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg>
        </span>
    `;
    div.querySelector('.delete-answer-btn').onmouseover = function() { this.style.color = '#fff'; };
    div.querySelector('.delete-answer-btn').onmouseout = function() { this.style.color = '#ccc'; };
    return div;
}

function renderStatisticsDashboard() {
    if (!adminDataCache || !adminDataCache.statsData) {
        showAlert("Data is not available yet. Please wait for the initial load to complete.");
        return;
    }
    let previouslySelectedSurvey = null;
    const statsData = adminDataCache.statsData;
    let currentSingleSurveyView = 'list';
    let activeCharts = [];
    let currentTimelineView = 'weighted';
    let activeTimelineAnswerInfo = { answer: null, question: null };
    let currentQuestionIndex = 0, currentSortKey = 'date', currentSortDirection = 'desc', topAnswersSortKey = 'count', topAnswersSortDirection = 'desc';

    function createCustomSelectHTML(containerId, options, isMultiSelect = false) {
        let optionsHtml = options.map(opt => `<li data-value="${opt.value}" class="${opt.selected ? 'selected' : ''}">${opt.label}<span class="tick-mark"></span></li>`).join('');
        return `
            <div class="custom-select" id="${containerId}" data-multi-select="${isMultiSelect}">
                <div class="select-display" tabindex="0"></div>
                <div class="select-options"><ul>${optionsHtml}</ul></div>
            </div>`;
    }

    function initCustomSelects() {
        document.querySelectorAll('.custom-select').forEach(container => {
            const display = container.querySelector('.select-display');
            const optionsList = container.querySelector('.select-options');
            const allOptions = container.querySelectorAll('li');
            const allOption = container.querySelector('li[data-value="all"]');
            const isMultiSelect = container.dataset.multiSelect === 'true';

            const updateDisplayText = () => {
                const selected = Array.from(container.querySelectorAll('li.selected'));
                if (selected.length === 0 || (selected.length === 1 && selected[0].dataset.value === 'all')) {
                    display.textContent = 'All';
                } else if (selected.length === 1) {
                    display.textContent = selected[0].textContent;
                } else {
                    display.textContent = `${selected.length} selections`;
                }
            };

            display.addEventListener('click', (e) => {
                e.stopPropagation();
                document.querySelectorAll('.custom-select.open').forEach(openSelect => {
                    if (openSelect !== container) openSelect.classList.remove('open');
                });
                container.classList.toggle('open');
            });

            optionsList.addEventListener('click', (e) => {
                e.stopPropagation();
                const li = e.target.closest('li');
                if (!li) return;

                const isAll = li.dataset.value === 'all';

                if (isMultiSelect) {
                    if (isAll) {
                        allOptions.forEach(opt => opt.classList.toggle('selected', opt === li));
                    } else {
                        li.classList.toggle('selected');
                        if (allOption) allOption.classList.remove('selected');
                        const anySelected = Array.from(allOptions).some(opt => opt.classList.contains('selected'));
                        if (!anySelected && allOption) allOption.classList.add('selected');
                    }
                } else {
                    allOptions.forEach(opt => opt.classList.remove('selected'));
                    li.classList.add('selected');
                    container.classList.remove('open');
                }
                
                updateDisplayText();
                updateDisplay();
            });
            updateDisplayText();
        });
        
        window.addEventListener('click', () => {
             document.querySelectorAll('.custom-select.open').forEach(openSelect => {
                openSelect.classList.remove('open');
            });
        });
    }

    function getSelectedValues(containerId) {
        const container = document.getElementById(containerId);
        if (!container) return ['all'];
        const selected = Array.from(container.querySelectorAll('li.selected'));
        return selected.map(li => li.dataset.value);
    }
    
   function renderUI() {
        const viewOptions = [
            { value: 'all-answers', label: 'All answers', selected: true }, // <-- IZMENJENO OVDE
            { value: 'top', label: 'Top answers', selected: false }
        ];
        const surveyOptions = [{ value: 'all', label: 'All', selected: true }]
            .concat(statsData.surveys.map(s => ({ value: s.name, label: s.name, selected: false })));
        const companyOptions = [{ value: 'all', label: 'All', selected: true }]
            .concat(statsData.companyNames.map(c => ({ value: c, label: c, selected: false })));
        const ageOptions = [
            { value: 'all', label: 'All', selected: true },
            { value: '21-30', label: '21-30', selected: false },
            { value: '31-40', label: '31-40', selected: false },
            { value: '41-50', label: '41-50', selected: false },
            { value: '50+', label: '50+', selected: false }
        ];

        adminPanelContainer.innerHTML = `<div class="admin-page-content">
            <a href="#" class="admin-back-button" style="display: flex; align-items: center; gap: 5px;"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20" fill="currentColor"><path d="M400-80 0-480l400-400 56 57-343 343 343 343-56 57Z"/></svg><span>Back to Admin Panel</span></a>
            <h1 style="display: flex; align-items: center; justify-content: center; gap: 15px;"><svg xmlns="http://www.w3.org/2000/svg" height="32" viewBox="0 0 24 24" width="32" fill="currentColor"><path d="M5 9.2h3V19H5zM10.6 5h2.8v14h-2.8zm5.6 8H19v6h-2.8z"/></svg>Statistics</h1>
            <div id="stats-content" class="stats-dashboard"></div>
        </div>`;
        document.querySelector('.admin-back-button').addEventListener('click', (e) => { e.preventDefault(); renderAdminMainMenu(); });
        document.getElementById('stats-content').innerHTML = `
            <div class="stats-filters">
                <div class="stats-filter-group"><label>View</label>${createCustomSelectHTML('answers-filter-container', viewOptions, false)}</div>
                <div class="stats-filter-group"><label>Select Survey</label>${createCustomSelectHTML('survey-select-container', surveyOptions, false)}</div>
                <div class="stats-filter-group"><label>Select Company</label>${createCustomSelectHTML('company-filter-container', companyOptions, true)}</div>
                <div class="stats-filter-group"><label>Age</label>${createCustomSelectHTML('age-filter-container', ageOptions, true)}</div>
                <div class="stats-filter-group"><label>Date Range</label><div class="date-range-filter"><input type="date" id="date-from" class="admin-date-input"><input type="date" id="date-to" class="admin-date-input"></div></div>
            </div>
            <div class="clear-filters-wrapper"><button id="clear-filters-btn" class="clear-filters-btn">Clear all filters</button></div>
            <div id="stats-view-container"></div>`;
            refreshAdminStatsView = updateDisplay;
        
        initCustomSelects();

        document.getElementById('date-from').addEventListener('change', updateDisplay);
        document.getElementById('date-to').addEventListener('change', updateDisplay);
        document.getElementById('clear-filters-btn').addEventListener('click', () => {
            ['answers-filter-container', 'survey-select-container', 'company-filter-container', 'age-filter-container'].forEach(id => {
                const container = document.getElementById(id);
                container.querySelectorAll('li').forEach(li => {
                    li.classList.toggle('selected', li.dataset.value === 'all');
                });
                container.querySelector('.select-display').textContent = 'All';
            });
            
            document.getElementById('date-from').value = '';
            document.getElementById('date-to').value = '';
            updateDisplay();
        });
        updateDisplay();
    }

    function updateDisplay() {
    const newSelectedSurvey = getSelectedValues('survey-select-container')[0];
    if (previouslySelectedSurvey !== newSelectedSurvey) {
        currentQuestionIndex = 0;
    }
    previouslySelectedSurvey = newSelectedSurvey;

    const answersFilter = getSelectedValues('answers-filter-container')[0];
        const selectedSurvey = getSelectedValues('survey-select-container')[0];
        const selectedCompanies = getSelectedValues('company-filter-container');
        const selectedAges = getSelectedValues('age-filter-container');
        
        const viewContainer = document.getElementById('stats-view-container');
        const dateFromInput = document.getElementById('date-from');
        const dateToInput = document.getElementById('date-to');
        const dateFrom = dateFromInput.value;
        const dateTo = dateToInput.value;

        let baseParticipants = (statsData.allParticipants || []);
        let filteredParticipants = baseParticipants;
        
        if (selectedSurvey !== 'all') {
            filteredParticipants = filteredParticipants.filter(p => p.survey === selectedSurvey);
        }
        if (!selectedCompanies.includes('all') && !selectedCompanies.includes('All Combined')) {
    filteredParticipants = filteredParticipants.filter(p => selectedCompanies.includes(p.company));
}
        if (!selectedAges.includes('all')) {
            filteredParticipants = filteredParticipants.filter(p => {
                const age = parseInt(p.age, 10);
                if (isNaN(age)) return false;
                return selectedAges.some(ageRange => {
                    if (ageRange === '21-30') return age >= 21 && age <= 30;
                    if (ageRange === '31-40') return age >= 31 && age <= 40;
                    if (ageRange === '41-50') return age >= 41 && age <= 50;
                    if (ageRange === '50+') return age >= 50;
                    return false;
                });
            });
        }
       if (dateFrom) {
            filteredParticipants = filteredParticipants.filter(p => {
                if (!p.date) return false;
                const participantDateObj = new Date(p.date);
                if (isNaN(participantDateObj.getTime())) return false;
                const pY = participantDateObj.getFullYear();
                const pM = String(participantDateObj.getMonth() + 1).padStart(2, '0');
                const pD = String(participantDateObj.getDate()).padStart(2, '0');
                const participantDateString = `${pY}-${pM}-${pD}`;
                return participantDateString >= dateFrom;
            });
        }
        if (dateTo) {
            filteredParticipants = filteredParticipants.filter(p => {
                if (!p.date) return false;
                const participantDateObj = new Date(p.date);
                if (isNaN(participantDateObj.getTime())) return false;
                const pY = participantDateObj.getFullYear();
                const pM = String(participantDateObj.getMonth() + 1).padStart(2, '0');
                const pD = String(participantDateObj.getDate()).padStart(2, '0');
                const participantDateString = `${pY}-${pM}-${pD}`;
                return participantDateString <= dateTo;
            });
        }

        const sortedParticipants = sortParticipants(filteredParticipants, currentSortKey, currentSortDirection);
        if (answersFilter === 'top') {
            const frequencyMap = {};
            const questionTotalMap = {};
            sortedParticipants.forEach(p => {
                const survey = statsData.surveys.find(s => s.name === p.survey);
                if (!survey) return;

                survey.questions.forEach((question) => {
                    const response = p.responses[question.text];
                    
                    let q = JSON.parse(JSON.stringify(question));

                    const isRatingBasedOnType = q.type === 'rating_numbers' || q.type === 'rating_stars';
                    const isRatingBasedOnAnswers = response && (!q.options || q.options.length === 0) && /^[1-5]$/.test(String(response).trim());

                    if (isRatingBasedOnType || isRatingBasedOnAnswers) {
                        q.options = ['1', '2', '3', '4', '5'];
                        if (!isRatingBasedOnType) {
                            q.type = 'rating_numbers'; 
                        }
                    }

                    if (!response || !q.options || q.options.length <= 1) return;

                    const questionText = q.text;
                    if (!questionTotalMap[questionText]) {
                        questionTotalMap[questionText] = 0;
                    }
                    questionTotalMap[questionText]++;
                    const answers = response.toString().split(', ');
                    answers.forEach(fullAnswer => {
                        if (!fullAnswer.trim()) return;

                        let baseAnswer = fullAnswer.split('::score=')[0].replace('::textfield=true', '').trim();
                        let userText = '';
                        baseAnswer = baseAnswer.replace(/\(please specify\)/gi, '').trim();
                        if (fullAnswer.includes(': ')) {
                           const parts = fullAnswer.split(': ');
                           if(q.options.some(opt => opt.startsWith(parts[0]))) {
                               baseAnswer = parts[0].split('::score=')[0].replace('::textfield=true', '').trim();
                               userText = `: ${parts.slice(1).join(': ')}`;
                           }
                        }

                        const matchingOption = q.options.find(opt => opt.split('::score=')[0].replace('::textfield=true', '').trim() === baseAnswer);
                        
                        let score = 'N/A';
                        if (matchingOption && matchingOption.includes('::score=')) {
                            score = `${matchingOption.split('::score=')[1].split('::')[0]} / 5`;
                        } else if (isRatingBasedOnType && /^[1-5]$/.test(baseAnswer)) {
                             score = `${baseAnswer} / 5`;
                        }

                        const displayAnswer = `${baseAnswer}${userText}`;
                        const key = `${p.survey}|${questionText}|${displayAnswer}`;

                        if (!frequencyMap[key]) {
                            frequencyMap[key] = { survey: p.survey, question: questionText, answer: displayAnswer, score: score, count: 0 };
                        }
                        frequencyMap[key].count++;
                    });
                });
            });
            let rankedAnswers = Object.values(frequencyMap).map(item => {
                const totalForQuestion = questionTotalMap[item.question] || 0;
                const percentage = totalForQuestion > 0 ? ((item.count / totalForQuestion) * 100).toFixed(1) + '%' : '0.0%';
                return { ...item, percentage };
            });
            rankedAnswers.sort((a, b) => {
                let valA, valB;
                const key = topAnswersSortKey;
                if (key === 'rank') { valA = b.count; valB = a.count; } else if (key === 'score') { valA = parseFloat(a.score) || 0; valB = parseFloat(b.score) || 0; } else if (key === 'percentage') { valA = parseFloat(a.percentage) || 0; valB = parseFloat(b.percentage) || 0; } else if (key === 'count') { valA = a.count; valB = b.count; } else { valA = (a[key] || '').toString().toLowerCase(); valB = (b[key] || '').toString().toLowerCase(); }
                let comparison = 0;
                if (valA > valB) comparison = 1;
                else if (valA < valB) comparison = -1;
                return topAnswersSortDirection === 'asc' ? comparison : -comparison;
            });
            viewContainer.innerHTML = `<div class="top-answers-container"><div class="top-answers-controls"><button class="top-answers-limit-btn" data-limit="all">All</button><button class="top-answers-limit-btn" data-limit="5">Top 5</button><button class="top-answers-limit-btn" data-limit="10">Top 10</button><button class="top-answers-limit-btn" data-limit="20">Top 20</button></div><div class="top-answers-table-wrapper"><table class="top-answers-table"><thead><tr><th><span class="sortable-header" data-sort-by="rank">Rank<i class="sort-icon"></i></span></th><th><span class="sortable-header" data-sort-by="answer">Answer<i class="sort-icon"></i></span></th><th><div class="th-content-wrapper"><span class="sortable-header" data-sort-by="score">Rating<i class="sort-icon"></i></span><span class="info-icon" data-tooltip="The administrator-assigned score for this answer."><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M440-280h80v-240h-80v240Zm40-320q17 0 28.5-11.5T520-640q0-17-11.5-28.5T480-680q-17 0-28.5 11.5T440-640q0 17 11.5 28.5T480-600Zm0 520q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/></svg></span></div></th><th><div class="th-content-wrapper"><span class="sortable-header" data-sort-by="count">Total<i class="sort-icon"></i></span><span class="info-icon" data-tooltip="The total number of times this answer was selected across all filtered participants."><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M440-280h80v-240h-80v240Zm40-320q17 0 28.5-11.5T520-640q0-17-11.5-28.5T480-680q-17 0-28.5 11.5T440-640q0 17 11.5 28.5T480-600Zm0 520q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/></svg></span></div></th><th><div class="th-content-wrapper"><span class="sortable-header" data-sort-by="percentage">%<i class="sort-icon"></i></span><span class="info-icon" data-tooltip="The percentage of times this answer was chosen for its specific question, out of all responses to that question."><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M440-280h80v-240h-80v240Zm40-320q17 0 28.5-11.5T520-640q0-17-11.5-28.5T480-680q-17 0-28.5 11.5T440-640q0 17 11.5 28.5T480-600Zm0 520q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/></svg></span></div></th></tr></thead><tbody id="top-answers-table-body"></tbody></table></div></div>`;
            let currentLimit = 'all';
            const controlsContainer = viewContainer.querySelector('.top-answers-controls');
            const limitButtons = controlsContainer.querySelectorAll('.top-answers-limit-btn');
            const updateActiveButton = () => {
                limitButtons.forEach(btn => {
                    if (btn.dataset.limit === currentLimit) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            };
            controlsContainer.addEventListener('click', e => {
                if (e.target.matches('.top-answers-limit-btn')) {
                    currentLimit = e.target.dataset.limit;
                    updateActiveButton();
                    renderTopAnswersTable(rankedAnswers, currentLimit);
                }
            });
            const tableHeader = viewContainer.querySelector('.top-answers-table thead');
            tableHeader.querySelectorAll('.sortable-header').forEach(header => {
                if (header.dataset.sortBy === topAnswersSortKey) {
                    header.classList.add('active');
                    const icon = header.querySelector('.sort-icon');
                    icon.classList.add(topAnswersSortDirection);
                }
            });
            tableHeader.addEventListener('click', e => {
                const header = e.target.closest('.sortable-header');
                if (!header) return;
                const newSortKey = header.dataset.sortBy;
                if (topAnswersSortKey === newSortKey) {
                    topAnswersSortDirection = topAnswersSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    topAnswersSortKey = newSortKey;
                    topAnswersSortDirection = (newSortKey === 'answer') ? 'asc' : 'desc';
                }
                updateDisplay();
            });
            updateActiveButton();
            renderTopAnswersTable(rankedAnswers, currentLimit);
        } else {
            activeCharts.forEach(chart => chart.destroy());
            activeCharts = [];
            const totals = { total: sortedParticipants.length };
            statsData.companyNames.forEach(c => { totals[c] = 0; });
            sortedParticipants.forEach(p => { if (totals.hasOwnProperty(p.company)) totals[p.company]++; });
            const summaryHtml = `Total Participants: <b>${totals.total}</b>  |  ${statsData.companyNames.map(c => `${c}: <b>${totals[c]}</b>`).join('  |  ')}`;
            if (selectedSurvey === 'all') {
                viewContainer.innerHTML = `<div class="all-surveys-layout"><div class="text-summary-stats">${summaryHtml}</div><div class="participant-list-container"><input type="text" id="participant-search" class="admin-input" placeholder="Search participants..."><div class="participant-list-header"><span class="sortable-header" data-sort-by="survey">SURVEY<i class="sort-icon"></i></span><span class="sortable-header" data-sort-by="participant">PARTICIPANT<i class="sort-icon"></i></span><span></span><span class="sortable-header" data-sort-by="age">AGE<i class="sort-icon"></i></span><span class="sortable-header" data-sort-by="company">COMPANY<i class="sort-icon"></i></span><span class="sortable-header" data-sort-by="date">DATE<i class="sort-icon"></i></span><span class="sortable-header" data-sort-by="rate">Rating<i class="sort-icon"></i></span><span></span><span style="text-align: right;">Actions</span></div><ul id="all-participants-list" class="participant-list"></ul></div></div>`;
                renderAllParticipantsList(sortedParticipants);
            } else {
                viewContainer.innerHTML = `<div id="single-survey-content-wrapper"><div id="single-survey-content"></div></div>`;
                const contentAreaContainer = document.getElementById('single-survey-content-wrapper');
    if (contentAreaContainer) {
        const newContainer = contentAreaContainer.cloneNode(true);
        contentAreaContainer.parentNode.replaceChild(newContainer, contentAreaContainer);

        newContainer.addEventListener('click', (e) => {
            const listBtn = e.target.closest('#icon-list-btn');
            const dashboardBtn = e.target.closest('#icon-dashboard-btn');

            if (listBtn && currentSingleSurveyView !== 'list') {
                currentSingleSurveyView = 'list';
                renderView('list');
            } else if (dashboardBtn && currentSingleSurveyView !== 'dashboard') {
                currentSingleSurveyView = 'dashboard';
                renderView('dashboard');
            }
        });
    }
                const renderView = (view) => {
    const contentArea = document.getElementById('single-survey-content');
    contentArea.innerHTML = ''; 

    const summaryTextHtml = `<div class="text-summary-stats">${summaryHtml}</div>`;

    const switcherHtml = `
        <div class="view-icon-switcher">
            <button id="icon-list-btn" data-view="list" class="view-icon-btn ${view === 'list' ? 'active' : ''}" title="List View">
                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="currentColor"><path d="M120-280v-80h560v80H120Zm0-160v-80h560v80H120Zm0-160v-80h560v80H120Z"/></svg>
                <span>List</span>
            </button>
            <button id="icon-dashboard-btn" data-view="dashboard" class="view-icon-btn ${view === 'dashboard' ? 'active' : ''}" title="Dashboard View">
                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="currentColor"><path d="M120-120v-560h240v560H120Zm280 0v-320h240v320H400Zm280 0v-440h240v440H680Z"/></svg>
                <span>Dashboard</span>
            </button>
        </div>`;
    contentArea.innerHTML = summaryTextHtml + switcherHtml;

    const companyFilterContainer = document.getElementById('company-filter-container');
    const allCombinedOption = companyFilterContainer.querySelector('li[data-value="All Combined"]');
    const allOption = companyFilterContainer.querySelector('li[data-value="all"]');

    if (view === 'list') {
        if (allOption) allOption.style.display = 'flex';
        if (allCombinedOption) {
            if (allCombinedOption.classList.contains('selected')) {
                companyFilterContainer.querySelector('li[data-value="all"]').classList.add('selected');
                companyFilterContainer.querySelector('.select-display').textContent = 'All';
            }
            allCombinedOption.remove();
        }

        const listHtml = `<div class="participant-list-container full-width"><input type="text" id="participant-search" class="admin-input" placeholder="Search participants..."><div class="participant-list-header"><span class="sortable-header" data-sort-by="survey">SURVEY<i class="sort-icon"></i></span><span class="sortable-header" data-sort-by="participant">PARTICIPANT<i class="sort-icon"></i></span><span></span><span class="sortable-header" data-sort-by="age">AGE<i class="sort-icon"></i></span><span class="sortable-header" data-sort-by="company">COMPANY<i class="sort-icon"></i></span><span class="sortable-header" data-sort-by="date">DATE<i class="sort-icon"></i></span><span class="sortable-header" data-sort-by="rate">Rating<i class="sort-icon"></i></span><span></span><span style="text-align: right;">Actions</span></div><ul id="all-participants-list" class="participant-list"></ul></div>`;
        contentArea.insertAdjacentHTML('beforeend', listHtml);
        renderAllParticipantsList(sortedParticipants);
    } else {
        if (companyFilterContainer && !allCombinedOption) {
            const optionsList = companyFilterContainer.querySelector('.select-options ul');
            if (optionsList) optionsList.insertAdjacentHTML('afterbegin', '<li data-value="All Combined">All Combined<span class="tick-mark"></span></li>');
        }
        if (allOption) {
             if (allOption.classList.contains('selected')) {
                const combinedOption = companyFilterContainer.querySelector('li[data-value="All Combined"]');
                if (combinedOption) combinedOption.classList.add('selected');
                allOption.classList.remove('selected');
                companyFilterContainer.querySelector('.select-display').textContent = 'All Combined';
            }
            allOption.style.display = 'none';
        }
        displaySingleSurveyDetails(selectedSurvey, selectedCompanies, sortedParticipants);
    }
};
renderView(currentSingleSurveyView);
};
            const listHeader = viewContainer.querySelector('.participant-list-header');
            if (listHeader) {
                listHeader.addEventListener('click', (e) => {
                    const header = e.target.closest('.sortable-header');
                    if (!header) return;
                    const newSortKey = header.dataset.sortBy;
                    if (currentSortKey === newSortKey) {
                        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSortKey = newSortKey;
                        currentSortDirection = newSortKey === 'date' ? 'desc' : 'asc';
                    }
                    updateDisplay();
                });
                document.querySelectorAll('.sortable-header').forEach(header => {
                    header.classList.remove('active');
                    const icon = header.querySelector('.sort-icon');
                    icon.classList.remove('asc', 'desc');
                    if (header.dataset.sortBy === currentSortKey) {
                        header.classList.add('active');
                        icon.classList.add(currentSortDirection);
                    }
                });
            }
        }
    }

    function displaySingleSurveyDetails(surveyName, companyFilter, filteredParticipants) {
        const contentArea = document.getElementById('single-survey-content');
        const survey = statsData.surveys.find(s => s.name === surveyName);
        if (!contentArea) return;
        if (!survey || !survey.questions || survey.questions.length === 0) {
            contentArea.innerHTML = '<p style="text-align:center; padding: 20px;">No questions or data found for this survey.</p>';
            return;
        }
        if (timelineChartInstance) {
            timelineChartInstance.destroy();
            timelineChartInstance = null;
        }
        const dashboardHtml = `<div class="stats-overall-layout"><div id="question-card-main-wrapper"></div><div class="stats-right-column"><div class="stats-timeline-chart-container" id="timeline-container"><div class="timeline-info-icon" id="timeline-info" data-tooltip=""><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24"><path d="M440-280h80v-240h-80v240Zm40-320q17 0 28.5-11.5T520-640q0-17-11.5-28.5T480-680q-17 0-28.5-11.5T440-640q0 17 11.5 28.5T480-600Zm0 520q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/></svg></div><div id="timeline-placeholder" style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; color: rgba(255, 255, 255, 0.3); text-align: center; padding: 20px;"><svg xmlns="http://www.w3.org/2000/svg" height="80" viewBox="0 -960 960 960" width="80" fill="currentColor"><path d="M120-120v-80h720v80H120Zm112-160-84-84 213-212 159 159 253-253 56 56-309 309-159-159-157 157Z"/></svg><p style="margin-top: 10px; font-size: 1.1rem;">Select an answer to view its trend</p></div><canvas id="timeline-chart" style="display: none;"></canvas><div class="timeline-chart-nav" style="display: none;"><span class="timeline-chart-nav-dot active" data-view="weighted"></span><span class="timeline-chart-nav-dot" data-view="count"></span><span class="timeline-chart-nav-dot" data-view="percentage"></span></div></div></div></div>`;
contentArea.insertAdjacentHTML('beforeend', dashboardHtml);
        const overallLayout = contentArea.querySelector('.stats-overall-layout');
        if (overallLayout) {
            overallLayout.addEventListener('click', (e) => {
                if (e.target.closest('#next-question')) {
                    if (currentQuestionIndex < survey.questions.length - 1) {
                        currentQuestionIndex++;
                        renderQuestion(currentQuestionIndex);
                    }
                }
                if (e.target.closest('#prev-question')) {
                     if (currentQuestionIndex > 0) {
                        currentQuestionIndex--;
                        renderQuestion(currentQuestionIndex);
                    }
                }
            });
        }

        const generalTooltipText = 'This chart displays the trend of a selected answer over time. Click on any answer on the left to see its data. You can switch between different views using the dots that will appear below the chart.';
        const infoIcon = document.getElementById('timeline-info');
        if (infoIcon) {
            infoIcon.setAttribute('data-tooltip', generalTooltipText);
        }

        function renderQuestion(index) {
            const q = { ...survey.questions[index] };
            
            const submittedAnswers = filteredParticipants.map(p => p.responses[q.text]).filter(response => response && String(response).trim() !== '');
            const isRatingBasedOnType = q.type === 'rating_numbers' || q.type === 'rating_stars';

            if (isRatingBasedOnType) {
                q.options = ['1', '2', '3', '4', '5'];
            }
            
            const questionCardContainer = document.getElementById('question-card-main-wrapper');
            const allCompanyNames = statsData.companyNames;
            const colors = { 'SMJ': 'rgba(217, 48, 37, 0.9)', 'EB Infinity': 'rgba(0, 123, 255, 0.9)', 'AmongUs': 'rgba(255, 255, 255, 0.9)' };
            let answersHtml;
            let legendHtml;
            const companyFilter = getSelectedValues('company-filter-container');

            if (!q.options || q.options.length === 0) {
                if (submittedAnswers.length > 0) {
                    answersHtml = `<div class="stats-freetext-answers-container">${submittedAnswers.map(answer => `<div class="stats-freetext-answer-item">${String(answer).replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>`).join('')}</div>`;
                } else {
                    answersHtml = '<div class="stats-freetext-no-answers">No answers submitted for this question.</div>';
                }
                legendHtml = '';
            } else if (companyFilter[0] === 'All Combined') {
                 answersHtml = q.options.map(opt => {
                    let cleanOpt = opt.split('::score=')[0].replace('::textfield=true', '').replace(/\(please (specify|explain)\)/gi, '').trim();
                    let answerDisplay = cleanOpt;

                    if (q.type === 'rating_stars' && /^[1-5]$/.test(cleanOpt)) {
                        const starSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="16" height="16" style="fill:#fff; margin-right:2px;"><path d="m233-120 65-281L80-590l288-25 112-265 112 265 288 25-218 189 65 281-247-149-247 149Z"/></svg>`;
                        answerDisplay = starSvg.repeat(parseInt(cleanOpt, 10));
                    }
                    const count = filteredParticipants.filter(p => {
    const answerCell = p.responses[q.text] || '';
    const respondentAnswers = answerCell.toString().split(', ');
    return respondentAnswers.some(ans => {
    const currentAnswer = ans.trim();
    const cleanOptKey = cleanOpt.split('::score=')[0].trim();
    if (currentAnswer.startsWith(cleanOptKey)) {
        return true;
    }
    return currentAnswer.split('::score=')[0].trim() === cleanOptKey;
});
}).length;
                    
                    const totalForQuestion = filteredParticipants.filter(p => p.responses[q.text]).length;
                    const percentage = totalForQuestion > 0 ? (count / totalForQuestion) * 100 : 0;

                    const miniBarHtml = `<div class="stats-mini-bar" style="width: ${percentage}%; background-color: #FFD700;" title="All Combined: ${count} (${percentage.toFixed(1)}%)"></div>`;
                    const breakdownCountsHtml = `<div class="stats-company-count" style="color: #FFD700; min-width: 50px; text-align: right; justify-content: flex-end;"><span>${count}</span></div>`;

                    return `<div class="stats-answer-row" data-answer="${cleanOpt}" style="cursor: pointer;"><div class="stats-answer-item"><span class="stats-answer-text">${answerDisplay}</span><div class="stats-mini-bars-container">${miniBarHtml}</div></div><div class="stats-answer-breakdown-counts">${breakdownCountsHtml}</div></div>`;
                }).join('');
                legendHtml = `<div class="stats-legend-item"><div class="stats-legend-color-box" style="background-color: #FFD700;"></div><span>All Combined</span></div>`;
            } else {
                const dynamicResults = {};
                q.options.forEach(opt => {
                    const cleanOpt = opt.split('::score=')[0].replace('::textfield=true', '').replace(' (Please specify)', '').trim();
                    if (!dynamicResults[cleanOpt]) {
                        dynamicResults[cleanOpt] = {};
                        allCompanyNames.forEach(c => dynamicResults[cleanOpt][c] = 0);
                    }
                });
                filteredParticipants.forEach(p => {
                    const answerCell = p.responses[q.text] || '';
                    const respondentAnswers = answerCell.toString().split(', ');
                    const company = p.company;
                    respondentAnswers.forEach(ans => {
                        let answerToCount = ans;

                        if (answerToCount.includes(': ')) {
                            const basePart = answerToCount.split(':')[0];
                            const originalOption = q.options.find(opt => opt.startsWith(basePart));
                            if (originalOption) {
                                answerToCount = originalOption;
                            }
                        }
                        
                        const cleanKey = answerToCount.split('::score=')[0].replace('::textfield=true', '').replace(/\(please (specify|explain)\)/gi, '').trim();

                        if (dynamicResults[cleanKey] && dynamicResults[cleanKey].hasOwnProperty(company)) {
                            dynamicResults[cleanKey][company]++;
                        }
                    });
                });
                let companiesToDisplay = (companyFilter.includes('all')) ? allCompanyNames : companyFilter;
                answersHtml = q.options.map(opt => {
                    const cleanOpt = opt.split('::score=')[0].replace('::textfield=true', '').replace(/\(please (specify|explain)\)/gi, '').trim();
                     let answerDisplay = cleanOpt;
                    if (q.type === 'rating_stars' && /^[1-5]$/.test(cleanOpt)) {
                        const starSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="16" height="16" style="fill:#fff; margin-right:2px;"><path d="m233-120 65-281L80-590l288-25 112-265 112 265 288 25-218 189 65 281-247-149-247 149Z"/></svg>`;
                        answerDisplay = starSvg.repeat(parseInt(cleanOpt, 10));
                    }
                    const optionResults = dynamicResults[cleanOpt] || {};
                    const miniBarsHtml = companiesToDisplay.map(name => {
                        const count = optionResults[name] || 0;
                        const companyTotalForQuestion = filteredParticipants.filter(p => p.company === name && p.responses[q.text]).length;
                        const percentage = companyTotalForQuestion > 0 ? (count / companyTotalForQuestion) * 100 : 0;
                        return `<div class="stats-mini-bar" style="width: ${percentage}%; background-color: ${colors[name]};" title="${name}: ${count} (${percentage.toFixed(1)}%)"></div>`;
                    }).join('');
                    const breakdownCountsHtml = companiesToDisplay.map(name => {
                        const count = optionResults[name] || 0;
                        return `<div class="stats-company-count" style="color: ${colors[name]};"><span>•</span><span>${count}</span></div>`;
                    }).join('');
                    return `<div class="stats-answer-row" data-answer="${cleanOpt}" style="cursor: pointer;"><div class="stats-answer-item"><span class="stats-answer-text">${answerDisplay}</span><div class="stats-mini-bars-container">${miniBarsHtml}</div></div><div class="stats-answer-breakdown-counts">${breakdownCountsHtml}</div></div>`;
                }).join('');
                legendHtml = allCompanyNames.map(name => `<div class="stats-legend-item"><div class="stats-legend-color-box" style="background-color: ${colors[name]};"></div><span>${name}</span></div>`).join('');
            }
            if (questionCardContainer) {
                const progressPercentage = ((index + 1) / survey.questions.length) * 100;
                questionCardContainer.innerHTML = `<div class="stats-question-view"><div id="prev-question" class="stats-nav-button"><svg xmlns="http://www.w3.org/2000/svg" height="35" viewBox="0 -960 960 960" width="35" fill="currentColor"><path d="M400-80 0-480l400-400 56 57-343 343 343 343-56 57Z"/></svg></div><div id="question-card-container"><div class="stats-question-card"><div class="timeline-info-icon" data-tooltip="This card displays the survey questions. Next to each answer, the colored lines represent the percentage of responses for that answer, broken down by company. The numbers show the exact count of responses. Click on any answer to see its trend over time in the chart on the right."><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24"><path d="M440-280h80v-240h-80v240Zm40-320q17 0 28.5-11.5T520-640q0-17-11.5-28.5T480-680q-17 0-28.5 11.5T440-640q0 17 11.5 28.5T480-600Zm0 520q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/></svg></div><h3 class="stats-question-title">${q.text || q.question}</h3><div class="stats-answers-container">${answersHtml}</div><div class="stats-legend"><div class="progress-line-container"><div class="progress-line-fill" style="width: ${progressPercentage}%;"></div></div>${legendHtml}</div></div></div><div id="next-question" class="stats-nav-button"><svg xmlns="http://www.w3.org/2000/svg" height="35" viewBox="0 -960 960 960" width="35" fill="currentColor"><path d="m304-82-56-57 343-343-343-343 56-57 400 400L304-82Z"/></svg></div></div>`;
                
                const prevBtn = document.getElementById('prev-question');
                const nextBtn = document.getElementById('next-question');
                if(prevBtn) prevBtn.classList.toggle('disabled', currentQuestionIndex === 0);
                if(nextBtn) nextBtn.classList.toggle('disabled', currentQuestionIndex === survey.questions.length - 1);
                
                const answersContainer = document.querySelector('.stats-answers-container');
                const timelineNav = document.querySelector('.timeline-chart-nav');
                timelineNav.addEventListener('click', e => {
                    if (e.target.matches('.timeline-chart-nav-dot')) {
                        currentTimelineView = e.target.dataset.view;
                        timelineNav.querySelectorAll('.timeline-chart-nav-dot').forEach(dot => dot.classList.remove('active'));
                        e.target.classList.add('active');
                        if (activeTimelineAnswerInfo.answer) {
                            generateTimelineDataAndRenderChart(activeTimelineAnswerInfo, filteredParticipants, survey, allCompanyNames, colors);
                        }
                    }
                });
                answersContainer.addEventListener('click', (e) => {
                    const answerRow = e.target.closest('.stats-answer-row');
                    if (answerRow) {
                        const selectedAnswer = answerRow.dataset.answer;
                        document.querySelectorAll('.stats-answer-row').forEach(row => row.style.background = 'rgba(0, 0, 0, 0.25)');
                        answerRow.style.background = 'rgba(0, 123, 255, 0.3)';
                        activeTimelineAnswerInfo = { answer: selectedAnswer, question: q };
                        generateTimelineDataAndRenderChart(activeTimelineAnswerInfo, filteredParticipants, survey, allCompanyNames, colors);
                    }
                });
                if (activeTimelineAnswerInfo.answer && activeTimelineAnswerInfo.question.text === q.text) {
                    const answerRow = answersContainer.querySelector(`.stats-answer-row[data-answer="${activeTimelineAnswerInfo.answer}"]`);
                    if (answerRow) {
                        answerRow.style.background = 'rgba(0, 123, 255, 0.3)';
                        generateTimelineDataAndRenderChart(activeTimelineAnswerInfo, filteredParticipants, survey, allCompanyNames, colors);
                    }
                }
            }
        }
        renderQuestion(currentQuestionIndex);
    }

    function generateTimelineDataAndRenderChart(answerInfo, participants, survey, companies, colors) {
        const infoIcon = document.getElementById('timeline-info');
    if (infoIcon) {
        const tooltips = {
            weighted: 'Weighted View: Displays a smoothed trend line. The percentage of responses for the selected answer is weighted by the number of total responses in that time period. This reduces the impact of outliers from periods with very few responses.',
            count: 'Count View: Displays the absolute number of times the selected answer was chosen in each time period (day, week, or month).',
            percentage: 'Percentage View: Displays the raw percentage of the selected answer compared to all other answers for that question within each time period.'
        };
        infoIcon.setAttribute('data-tooltip', tooltips[currentTimelineView]);
    }
        if (timelineChartInstance) {
            timelineChartInstance.destroy();
            timelineChartInstance = null;
        }
        const placeholder = document.getElementById('timeline-placeholder');
        const canvas = document.getElementById('timeline-chart');
        if (!placeholder || !canvas) return;
        const timelineNav = document.querySelector('.timeline-chart-nav');

        const questionIndex = survey.questions.findIndex(q => q.text === answerInfo.question.text);
        if (questionIndex === -1) return;

        placeholder.style.display = 'none';
        canvas.style.display = 'block';
        if (timelineNav) timelineNav.style.display = 'flex';

        const allParticipantDates = participants
            .map(p => p.date ? new Date(p.date) : null)
            .filter(d => d !== null)
            .sort((a, b) => a - b);

        if (allParticipantDates.length === 0) {
            placeholder.innerHTML = `<p>No date data available for this selection.</p>`;
            placeholder.style.display = 'flex';
            canvas.style.display = 'none';
            return;
        }

        const dateFromInput = document.getElementById('date-from');
        const dateToInput = document.getElementById('date-to');

        let startDateString = dateFromInput.value;
        if (!startDateString) {
            startDateString = allParticipantDates[0].toISOString().slice(0, 10);
        }

        let endDateString = dateToInput.value;
        if (!endDateString) {
            endDateString = allParticipantDates[allParticipantDates.length - 1].toISOString().slice(0, 10);
        }

        const startDate = new Date(startDateString);
        const endDate = new Date(endDateString);
        
        const labels = [];
        const timeDiff = endDate.getTime() - startDate.getTime();
        const dayDiff = timeDiff / (1000 * 3600 * 24);

        let grouping = 'daily';
        if (dayDiff > 90) {
            grouping = 'monthly';
        } else if (dayDiff > 30) {
            grouping = 'weekly';
        }

        if (grouping === 'monthly') {
            let current = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
            while (current <= endDate) {
                labels.push(current.toISOString().slice(0, 7));
                current.setMonth(current.getMonth() + 1);
            }
        } else if (grouping === 'weekly') {
            let current = new Date(startDate);
            while (current <= endDate) {
                labels.push(current.toISOString().slice(0, 10));
                current.setDate(current.getDate() + 7);
            }
        } else {
            let current = new Date(startDate);
            while (current <= endDate) {
                labels.push(current.toISOString().slice(0, 10));
                current.setDate(current.getDate() + 1);
            }
        }

        let datasets;
        const selectedCompanies = getSelectedValues('company-filter-container');
        
        const processData = (participantsForPeriod) => {
    if (participantsForPeriod.length === 0) return null;

    const currentQuestion = answerInfo.question;

    const selectedAnswerCountInPeriod = participantsForPeriod.filter(p => {
        const response = p.responses[currentQuestion.text] || '';
        const participantAnswers = response.toString().split(', ');
        return participantAnswers.some(rawAnswer => {
            const basePart = rawAnswer.split(':')[0].split('::score=')[0].replace('::textfield=true', '').replace(/\(please (specify|explain)\)/gi, '').trim();
            return basePart === answerInfo.answer;
        });
    }).length;

    if (currentTimelineView === 'count') {
        return selectedAnswerCountInPeriod;
    }

    let validOptions;
    if (currentQuestion.type === 'rating_numbers' || currentQuestion.type === 'rating_stars') {
        validOptions = ['1', '2', '3', '4', '5'];
    } else if (currentQuestion.type === 'paragraph') {
        validOptions = null;
    } else {
        validOptions = (currentQuestion.options || []).map(opt =>
            opt.split('::score=')[0].replace('::textfield=true', '').replace(/\(please (specify|explain)\)/gi, '').trim()
        );
    }

    const totalResponsesForQuestionInPeriod = participantsForPeriod.filter(p => {
        const response = p.responses[currentQuestion.text];
        if (!response || String(response).trim() === '') return false;

        if (validOptions === null) {
            return true;
        }
        
        const participantAnswers = String(response).split(', ');
        return participantAnswers.some(pAnswer => {
            const basePAnswer = pAnswer.split(':')[0].split('::score=')[0].replace('::textfield=true', '').replace(/\(please (specify|explain)\)/gi, '').trim();
            return validOptions.includes(basePAnswer);
        });
    }).length;

    if (totalResponsesForQuestionInPeriod === 0) {
        return 0;
    }
    
    const percentage = (selectedAnswerCountInPeriod / totalResponsesForQuestionInPeriod) * 100;
    
    return percentage;
};
if (selectedCompanies[0] === 'All Combined') {
     const data = [];
     let lastValidValue = 0;
     labels.forEach(label => {
        let periodParticipants = [];
        if (grouping === 'monthly') {
            const year = parseInt(label.substring(0, 4), 10);
            const month = parseInt(label.substring(5, 7), 10) - 1;
            periodParticipants = participants.filter(p => {
                if (!p.date) return false;
                const pDate = new Date(p.date);
                return pDate.getFullYear() === year && pDate.getMonth() === month;
            });
        } else if (grouping === 'weekly') {
            const weekStart = new Date(label);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 7);
            periodParticipants = participants.filter(p => {
                if (!p.date) return false;
                const pDate = new Date(p.date);
                return pDate >= weekStart && pDate < weekEnd;
            });
        } else {
            periodParticipants = participants.filter(p => p.date && p.date.slice(0, 10) === label);
        }
        
        const newValue = processData(periodParticipants);

        if (newValue !== null) {
            if (currentTimelineView === 'weighted') {
                 const weight = Math.min(periodParticipants.length / 10, 1);
                 const smoothedValue = (lastValidValue * (1 - weight)) + (newValue * weight);
                 data.push(smoothedValue);
                 lastValidValue = smoothedValue;
            } else {
                 data.push(newValue);
            }
        } else {
             data.push(currentTimelineView === 'weighted' ? lastValidValue : 0);
        }
    });

    datasets = [{
    label: 'All Combined',
    data: data,
    borderColor: '#FFD700',
    backgroundColor: '#FFD700',
    fill: false,
    tension: 0.2,
    borderWidth: 2
}];
} else {
    let allCompanyDatasets = companies.map(company => {
        const data = [];
        let lastValidValue = 0;
        labels.forEach(label => {
            let periodParticipants = [];
            if (grouping === 'monthly') {
                const year = parseInt(label.substring(0, 4), 10);
                const month = parseInt(label.substring(5, 7), 10) - 1;
                periodParticipants = participants.filter(p => {
                    if (!p.date) return false;
                    const pDate = new Date(p.date);
                    return p.company === company && pDate.getFullYear() === year && pDate.getMonth() === month;
                });
            } else if (grouping === 'weekly') {
                const weekStart = new Date(label);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 7);
                periodParticipants = participants.filter(p => {
                    if (!p.date) return false;
                    const pDate = new Date(p.date);
                    return p.company === company && pDate >= weekStart && pDate < weekEnd;
                });
            } else {
                periodParticipants = participants.filter(p => p.date && p.date.slice(0, 10) === label && p.company === company);
            }

            const newValue = processData(periodParticipants);
            
            if (newValue !== null) {
                if (currentTimelineView === 'weighted') {
                    const weight = Math.min(periodParticipants.length / 10, 1);
                    const smoothedValue = (lastValidValue * (1 - weight)) + (newValue * weight);
                    data.push(smoothedValue);
                    lastValidValue = smoothedValue;
                } else {
                    data.push(newValue);
                }
            } else {
                data.push(currentTimelineView === 'weighted' ? lastValidValue : 0);
            }
        });
        return {
    label: company,
    data: data,
    borderColor: colors[company],
    backgroundColor: colors[company],
    fill: false,
    tension: 0.2,
    borderWidth: 2
};
    });
    
    if (!selectedCompanies.includes('all')) {
        datasets = allCompanyDatasets.filter(ds => selectedCompanies.includes(ds.label));
    } else {
        datasets = allCompanyDatasets;
    }
}
        const ctx = document.getElementById('timeline-chart')?.getContext('2d');
        const verticalLinePlugin = {
            id: 'verticalLiner',
            afterDraw: chart => {
                if (chart.tooltip?._active?.length) {
                    let x = chart.tooltip._active[0].element.x;
                    let yAxis = chart.scales.y;
                    let ctx = chart.ctx;
                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(x, yAxis.getPixelForValue(yAxis.max));
                    ctx.lineTo(x, yAxis.getPixelForValue(yAxis.min));
                    ctx.lineWidth = 1;
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.25)';
                    ctx.stroke();
                    ctx.restore();
                }
            }
        };
        if (!ctx) return;
        // Pomoćna funkcija za prelamanje teksta
        function wrapChartTitle(text, maxLength) {
            const lines = [];
            const words = text.split(' ');
            let currentLine = '';

            words.forEach(word => {
                // Ako je sama reč duža od limita, moramo je slomiti
                if (word.length > maxLength) {
                    if (currentLine.length > 0) {
                        lines.push(currentLine);
                    }
                    let tempWord = word;
                    while (tempWord.length > maxLength) {
                        lines.push(tempWord.substring(0, maxLength));
                        tempWord = tempWord.substring(maxLength);
                    }
                    currentLine = tempWord;
                } else {
                    const testLine = currentLine + (currentLine === '' ? '' : ' ') + word;
                    if (testLine.length > maxLength && currentLine !== '') {
                        lines.push(currentLine);
                        currentLine = word;
                    } else {
                        currentLine = testLine;
                    }
                }
            });

            if (currentLine.length > 0) {
                lines.push(currentLine);
            }

            return lines.length > 0 ? lines : [''];
        }
        const wrappedAnswer = wrapChartTitle(answerInfo.answer, 50);
        const finalTitle = [
            `Trend for: "${wrappedAnswer[0]}${wrappedAnswer.length > 1 ? '' : '"'}`,
            ...wrappedAnswer.slice(1).map((line, index) => 
                index === wrappedAnswer.length - 2 ? `${line}"` : line
            ),
            `(${currentTimelineView} view, ${grouping})`
        ];
        timelineChartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            plugins: [verticalLinePlugin],
            options: {
    responsive: true,
    maintainAspectRatio: false,
    layout: {
        padding: {
            top: 10,
            right: 35,
            bottom: 20
        }
    },
    plugins: {
        legend: {
            position: 'bottom',
            labels: {
                color: '#fff',
                boxWidth: 15,
                boxHeight: 15,
                padding: 10,
                generateLabels: function(chart) {
                    const originalLabels = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                    originalLabels.forEach(label => {
                        const canvas = document.createElement('canvas');
                        canvas.width = 15;
                        canvas.height = 15;
                        const ctx = canvas.getContext('2d');
                        const r = 4;
                        ctx.fillStyle = label.fillStyle;
                        ctx.beginPath();
                        ctx.moveTo(r, 0); ctx.lineTo(15 - r, 0); ctx.quadraticCurveTo(15, 0, 15, r);
                        ctx.lineTo(15, 15 - r); ctx.quadraticCurveTo(15, 15, 15 - r, 15);
                        ctx.lineTo(r, 15); ctx.quadraticCurveTo(0, 15, 0, 15 - r);
                        ctx.lineTo(0, r); ctx.quadraticCurveTo(0, 0, r, 0);
                        ctx.closePath();
                        ctx.fill();
                        label.pointStyle = canvas;
                    });
                    return originalLabels;
                }
            }
        },
        title: {
            display: true,
           text: finalTitle,
            color: '#fff',
            padding: {
                top: 5,
                bottom: 25
            },
            font: {
                size: 14
            }
        },
        tooltip: {
            filter: function(tooltipItem) {
                const selectedCompanies = getSelectedValues('company-filter-container');
                if (selectedCompanies.includes('all')) {
                    return true;
                }
                return selectedCompanies.includes(tooltipItem.dataset.label);
            },
            callbacks: {
                label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) {
                        label += ': ';
                    }
                    if (context.parsed.y !== null) {
                        label += context.parsed.y.toFixed(currentTimelineView === 'percentage' || currentTimelineView === 'weighted' ? 2 : 0);
                        if (currentTimelineView === 'percentage' || currentTimelineView === 'weighted') label += '%';
                    }
                    return label;
                }
            }
        }
    },
    scales: {
        y: {
            beginAtZero: true,
            max: (currentTimelineView === 'percentage' || currentTimelineView === 'weighted') ? 100 : undefined,
            ticks: {
                callback: value => value.toFixed(0) + ((currentTimelineView === 'percentage' || currentTimelineView === 'weighted') ? '%' : ''),
                color: '#ccc'
            },
            grid: {
                color: 'rgba(255, 255, 255, 0.1)'
            }
        },
        x: {
            ticks: {
                color: '#ccc'
            },
            grid: {
                color: 'rgba(255, 255, 255, 0.1)'
            }
        }
    },
    interaction: {
        intersect: false,
        mode: 'index',
    },
}
}
    )}

function calculateAverageScore(participant) {
    if (!participant || !participant.responses || !adminDataCache || !adminDataCache.statsData) return 'N/A';
    
    const survey = adminDataCache.statsData.surveys.find(s => s.name === participant.survey);
    if (!survey) return 'N/A';

    let totalScore = 0;
    let scoredAnswersCount = 0;

    Object.keys(participant.responses).forEach(questionText => {
        let participantResponse = participant.responses[questionText];
        if (participantResponse === null || participantResponse === undefined) return;

        const responseStr = String(participantResponse).trim();
        if (responseStr === '') return;

        const questionObj = survey.questions.find(q => q.text === questionText);
        if (!questionObj) return;

        const participantAnswers = responseStr.split('|||');

        participantAnswers.forEach(singleAnswer => {
            const baseAnswer = singleAnswer.split('::score=')[0].replace('::textfield=true', '').trim();

            // ISPRAVKA: Eksplicitno proveravamo rejting pitanja PRVO
            if ((questionObj.type === 'rating_numbers' || questionObj.type === 'rating_stars')) {
                // Proveravamo da li je odgovor broj između 1 i 5
                if (/^[1-5]$/.test(baseAnswer)) {
                    const score = parseInt(baseAnswer, 10);
                    if (!isNaN(score)) {
                        totalScore += score;
                        scoredAnswersCount++;
                    }
                }
            }
            // Zatim proveravamo ostala pitanja koja mogu imati definisan skor
            else if (questionObj.options && questionObj.options.length > 0) {
                const matchingOption = questionObj.options.find(opt => {
                    const optionBase = opt.split('::score=')[0].replace('::textfield=true', '').trim();
                    return optionBase === baseAnswer;
                });

                if (matchingOption && matchingOption.includes('::score=')) {
                    const scorePart = matchingOption.split('::score=')[1];
                    const score = parseInt(scorePart, 10);
                    if (!isNaN(score)) {
                        totalScore += score;
                        scoredAnswersCount++;
                    }
                }
            }
        });
    });

    if (scoredAnswersCount === 0) {
        return 'N/A';
    }
    
    const average = totalScore / scoredAnswersCount;
    return `${average.toFixed(1)} / 5`;
}

    function sortParticipants(participants, key, direction) {
        return [...participants].sort((a, b) => {
            let valA, valB;
            if (key === 'age') {
                valA = parseInt(a.age, 10) || 0;
                valB = parseInt(b.age, 10) || 0;
            } else if (key === 'date') {
                valA = new Date(a.date);
                valB = new Date(b.date);
            } else if (key === 'rate') {
                valA = parseFloat(calculateAverageScore(a)) || 0;
                valB = parseFloat(calculateAverageScore(b)) || 0;
            } else {
                valA = (a[key] || '').toString().toLowerCase();
                valB = (b[key] || '').toString().toLowerCase();
            }
            let comparison = 0;
            if (valA > valB) {
                comparison = 1;
            } else if (valA < valB) {
                comparison = -1;
            }
            return direction === 'asc' ? comparison : -comparison;
        });
    }

    function showParticipantDetailsModal(participantData) {
        const existingModal = document.querySelector('.participant-modal-overlay');
        if (existingModal) existingModal.remove();
        const survey = statsData.surveys.find(s => s.name === participantData.survey);
        if (!survey) {
            showAlert('Could not find questions for this survey.');
            return;
        }
        let qaHtml = '';
        if (participantData.responses) {
            Object.keys(participantData.responses).forEach(questionText => {
                const questionObj = survey.questions.find(q => q.text === questionText);
                const rawAnswer = participantData.responses[questionText];
                const answerAsString = String(rawAnswer); 

                if (answerAsString && answerAsString.trim() !== '') {
                    let finalDisplayHtml;
                    const individualAnswers = answerAsString.split(', '); 

                    finalDisplayHtml = individualAnswers.map(answer => {
                        if (questionObj && questionObj.type === 'rating_stars' && /^[1-5]$/.test(answer)) {
                            const starSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="20" height="20" style="fill:#FFD700; margin-right:2px; vertical-align: bottom;"><path d="m233-120 65-281L80-590l288-25 112-265 112 265 288 25-218 189 65 281-247-149-247 149Z"/></svg>`;
                            return starSvg.repeat(parseInt(answer, 10));
                        }
                        
                        let baseAnswerRaw = answer.split('::score=')[0].replace('::textfield=true', '').trim();
                        let userEnteredText = '';

                        if(answer.includes(': ')){
                             const parts = answer.split(': ');
                             if(questionObj && questionObj.options.some(opt => opt.startsWith(parts[0]))) {
                                baseAnswerRaw = parts[0].split('::score=')[0].replace('::textfield=true', '').trim();
                                userEnteredText = `: ${parts.slice(1).join(': ')}`;
                             }
                        }
                        
                        let scoreSpan = '';
                        if (questionObj) {
                            if (questionObj.options && questionObj.options.length > 0) {
                                const matchingOption = questionObj.options.find(opt => opt.startsWith(baseAnswerRaw));
                                if (matchingOption && matchingOption.includes('::score=')) {
                                    const score = matchingOption.split('::score=')[1].split('::')[0];
                                    scoreSpan = ` <span class="qa-card-score">(Score: ${score}/5)</span>`;
                                }
                            } else if ((questionObj.type === 'rating_numbers') && /^[1-5]$/.test(baseAnswerRaw)) {
                                scoreSpan = ` <span class="qa-card-score">(Score: ${baseAnswerRaw}/5)</span>`;
                            }
                        }

                        let displayText = baseAnswerRaw.replace(/\(please (specify|explain)\)/gi, '').trim();
                        return `${displayText}${scoreSpan}${userEnteredText}`;

                    }).join('<br>');
                    qaHtml += `<div class="qa-card"><div class="qa-card-question">${questionText}</div><div class="qa-card-answer">${finalDisplayHtml}</div></div>`;
                }
            });
        }
        if (!qaHtml) {
            qaHtml = '<p style="text-align: center; opacity: 0.7;">This participant did not answer any questions.</p>';
        }
        const modal = document.createElement('div');
        modal.className = 'participant-modal-overlay';
        modal.innerHTML = `<div class="participant-modal-content"><div class="participant-modal-header"><h2>${participantData.participant}</h2><div style="display: flex; align-items: center; gap: 30px;"><div class="participant-modal-details"><div>Survey: <b>${participantData.survey}</b></div><div>Company: <b>${participantData.company}</b></div><div>Age: <b>${participantData.age || 'N/A'}</b></div></div><button class="participant-modal-close">&times;</button></div></div><div class="participant-modal-body">${qaHtml}</div></div>`;
        document.body.appendChild(modal);
        modal.querySelector('.participant-modal-close').addEventListener('click', () => {
            modal.remove();
        });
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }


    function renderAllParticipantsList(participants) {
    const duplicateTimestamps = findDuplicates(participants);
    const listElement = document.getElementById('all-participants-list');
    const searchInput = document.getElementById('participant-search');
    if (!listElement || !participants) return;

    let totalScoreSum = 0;
    let scoredParticipantsCount = 0;
    participants.forEach(p => {
        const scoreString = calculateAverageScore(p);
        if (scoreString !== 'N/A') {
            const scoreValue = parseFloat(scoreString.split(' / ')[0]);
            if (!isNaN(scoreValue)) {
                totalScoreSum += scoreValue;
                scoredParticipantsCount++;
            }
        }
    });
    const averageRating = scoredParticipantsCount > 0
        ? (totalScoreSum / scoredParticipantsCount).toFixed(1) + ' / 5'
        : 'N/A';

    function displayList(filteredParticipants) {
        listElement.innerHTML = '';
        filteredParticipants.forEach(p => {
            const date = new Date(p.date);
const options = { year: '2-digit', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: true };
const formattedDate = date.toLocaleString ? date.toLocaleString('en-US', options) : p.date;
            const rate = calculateAverageScore(p);
            const item = document.createElement('li');
            item.className = 'participant-list-item';
           const isDuplicate = duplicateTimestamps.has(p.date);
            const duplicateHtml = isDuplicate ? '<span><span class="duplicate-label">DUPLICATE</span></span>' : '<span></span>';
            
            item.innerHTML = `<span>${p.survey}</span><span>${p.participant}</span><span></span><span>${p.age || 'N/A'}</span><span>${p.company}</span><span>${formattedDate}</span><span>${rate}</span>${duplicateHtml}<span class="participant-delete-action"><button class="delete-participant-btn" data-timestamp="${p.date}" data-survey="${p.survey}" title="Delete Response"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20" fill="currentColor"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg></button></span>`;

            item.dataset.participantData = JSON.stringify(p);
            listElement.appendChild(item);
        });
    }
    displayList(participants);

    const container = listElement.closest('.participant-list-container');
    if (container) {
        let avgDisplay = container.querySelector('.average-rating-display');
        if (avgDisplay) {
            avgDisplay.remove();
        }
        const avgDisplayHtml = `
            <div class="average-rating-display">
                <span>Average Rating:</span> ${averageRating}
            </div>
        `;
        container.insertAdjacentHTML('beforeend', avgDisplayHtml);
    }

    searchInput.addEventListener('keyup', () => {
        const searchTerm = searchInput.value.toLowerCase();
        const filtered = participants.filter(p =>
            p.participant.trim().toLowerCase().startsWith(searchTerm)
        );
        displayList(filtered);
    });
   listElement.addEventListener('click', (e) => {
        const deleteBtn = e.target.closest('.delete-participant-btn');
        if (deleteBtn) {
            e.stopPropagation();
            const { timestamp, survey } = deleteBtn.dataset;
            const participantItem = deleteBtn.closest('.participant-list-item');
            const participantName = participantItem.querySelector('span:nth-child(2)').textContent;
            const isDuplicate = participantItem.querySelector('.duplicate-label');

            if (isDuplicate) {
                showDeleteConfirmationModal(
                    `This entry for "${participantName}" is marked as a duplicate. How would you like to proceed?`,
                    () => { // onConfirmSingle
                        deleteSingleParticipant(timestamp, survey, participantName);
                    },
                    () => { // onConfirmAll
                        deleteAllDuplicates(timestamp, survey);
                    }
                );
            } else {
                if (confirm(`Are you sure you want to delete the response from "${participantName}" for the "${survey}" survey?`)) {
                    deleteSingleParticipant(timestamp, survey, participantName);
                }
            }
            return;
        }

        const listItem = e.target.closest('.participant-list-item');
        if (listItem && listItem.dataset.participantData) {
            const participantData = JSON.parse(listItem.dataset.participantData);
            showParticipantDetailsModal(participantData);
        }
    });
}
    function renderTopAnswersTable(answers, limit) {
        const tableBody = document.getElementById('top-answers-table-body');
        if (!tableBody) return;
        const answersToShow = limit === 'all' ? answers : answers.slice(0, parseInt(limit));
        tableBody.innerHTML = answersToShow.map((item, index) => {
    const surveyForQuestion = adminDataCache.statsData.surveys.find(s => s.name === item.survey);
    const questionObj = surveyForQuestion ? surveyForQuestion.questions.find(q => q.text === item.question) : null;
    
    let answerDisplay = (item.answer || '').split('::')[0];
    const cleanScore = (item.score || '').split('::')[0];
    
    if (questionObj && questionObj.type === 'rating_stars' && /^[1-5]$/.test(answerDisplay)) {
        const starSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" width="20" height="20" style="fill:#FFD700; margin-right:2px;"><path d="m233-120 65-281L80-590l288-25 112-265 112 265 288 25-218 189 65 281-247-149-247 149Z"/></svg>`;
        answerDisplay = starSvg.repeat(parseInt(answerDisplay, 10));
    }
    return `
        <tr class="top-answers-row">
            <td class="rank">${index + 1}</td>
            <td class="answer-details" data-survey="Survey: ${item.survey}">
                <span class="question">${item.question}</span>
                <span class="answer">${answerDisplay}</span>
            </td>
            <td class="count">${cleanScore}</td>
            <td class="count">${item.count}</td>
            <td class="percentage">${item.percentage}</td>
        </tr>`;
}).join('');
    }

    renderUI();
}
    
    

function renderSurveyList(mode) {
    if (!adminDataCache || !adminDataCache.surveyNames) {
        showAlert("Data is not available yet. Please wait for the initial load to complete.");
        return;
    }

    let surveys = [...adminDataCache.surveyNames];

    surveys.sort((a, b) => {
        let valA, valB;
        if (surveyListSortKey === 'lastModified') {
            valA = new Date(a.lastModified);
            valB = new Date(b.lastModified);
        } else {
            valA = (a[surveyListSortKey] || '').toString().toLowerCase();
            valB = (b[surveyListSortKey] || '').toString().toLowerCase();
        }
        let comparison = 0;
        if (valA > valB) {
            comparison = 1;
        } else if (valA < valB) {
            comparison = -1;
        }
        return surveyListSortDirection === 'asc' ? comparison : -comparison;
    });

    const title = mode === 'edit' ? 'Edit Surveys' : 'View Statistics';
    let listHtml = surveys.map(s => {
        const dateString = s.lastModified;
        let formattedDateTime = 'N/A';
        if (dateString) {
            const date = new Date(dateString);
            const options = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: true };
            formattedDateTime = new Intl.DateTimeFormat('en-us', options).format(date).replace(',', '');
        }
        return `<li class="admin-list-item" data-id="${s.id}" data-name="${s.name}">
            <div class="admin-list-item-info"><span class="name">${s.name}</span></div>
            <div class="admin-list-item-url"><button class="url-btn" title="Get Survey Links"><svg xmlns="http://www.w3.org/2000/svg" height="22" viewBox="0 -960 960 960" width="22" fill="currentColor"><path d="M440-280H280q-83 0-141.5-58.5T80-480q0-83 58.5-141.5T280-680h160v80H280q-50 0-85 35t-35 85q0 50 35 85t85 35h160v80ZM320-440v-80h320v80H320Zm120 160v-80h160q50 0 85-35t35-85q0-50-35-85t-85-35H520v-80h160q83 0 141.5 58.5T880-480q0 83-58.5 141.5T680-280H520Z"/></svg></button></div>
            <div class="admin-list-item-date"><span>${formattedDateTime}</span></div>
            <div class="admin-list-item-actions"><button class="edit-btn" title="Edit"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="currentColor"><path d="M200-200h57l391-391-57-57-391 391v57Zm-80 80v-170l528-527q12-11 26.5-17t30.5-6q16 0 31 6t26 18l55 56q12 11 17.5 26t5.5 30q0 16-5.5 30.5T817-647L290-120H120Zm640-584-56-56 56 56Zm-141 85-28-29 57 57-29-28Z"/></svg></button><button class="delete-btn" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="currentColor"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg></button></div>
        </li>`;
    }).join('');
    if (surveys.length === 0) { listHtml = '<p style="text-align:center; padding: 20px;">No surveys found.</p>'; }
    adminPanelContainer.innerHTML = `<div class="admin-page-content">
        <a href="#" class="admin-back-button" style="display: flex; align-items: center; gap: 5px;"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20" fill="currentColor"><path d="M400-80 0-480l400-400 56 57-343 343 343 343-56 57Z"/></svg><span>Back to Admin Panel</span></a>
        <h1 style="display: flex; align-items: center; justify-content: center; gap: 15px;"><svg xmlns="http://www.w3.org/2000/svg" height="32" viewBox="0 -960 960 960" width="32" fill="currentColor"><path d="M200-200h57l391-391-57-57-391 391v57Zm-80 80v-170l528-527q12-11 26.5-17t30.5-6q16 0 31 6t26 18l55 56q12 11 17.5 26t5.5 30q0 16-5.5 30.5T817-647L290-120H120Zm640-584-56-56 56 56Zm-141 85-28-29 57 57-29-28Z"/></svg>${title}</h1>
        <input type="text" id="survey-search" class="admin-search-bar" placeholder="Search surveys...">
        <div class="admin-list-header">
            <span>Survey Name</span>
            <span style="text-align: center;">URLs</span>
            <span class="sortable-header" data-sort-by="lastModified">Last Modified<i class="sort-icon"></i></span>
            <span style="justify-self: end;">Actions</span>
        </div>
        <ul class="admin-list">${listHtml}</ul>
    </div>`;

    document.getElementById('survey-search').addEventListener('keyup', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        document.querySelectorAll('.admin-list-item').forEach(item => { item.style.display = item.dataset.name.toLowerCase().startsWith(searchTerm) ? 'grid' : 'none'; });
    });

    document.querySelector('.admin-back-button').addEventListener('click', renderAdminMainMenu);
    
    const listHeader = adminPanelContainer.querySelector('.admin-list-header');
    if (listHeader) {
        const activeHeader = listHeader.querySelector(`.sortable-header[data-sort-by="${surveyListSortKey}"]`);
        if (activeHeader) {
            activeHeader.classList.add('active');
            const icon = activeHeader.querySelector('.sort-icon');
            if (icon) {
                icon.classList.add(surveyListSortDirection);
            }
        }

        listHeader.addEventListener('click', (e) => {
            const header = e.target.closest('.sortable-header');
            if (!header) return;
            const newSortKey = header.dataset.sortBy;
            if (surveyListSortKey === newSortKey) {
                surveyListSortDirection = surveyListSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                surveyListSortKey = newSortKey;
                surveyListSortDirection = 'desc';
            }
            renderSurveyList(mode);
        });
    }

    document.querySelector('.admin-list').addEventListener('click', async e => {
        const button = e.target.closest('button');
        if (!button) return;
        const listItem = button.closest('.admin-list-item');
        const surveyId = listItem.dataset.id;
        const surveyName = listItem.dataset.name;

        console.log('CLICKED SURVEY ID:', surveyId);
        if (button.classList.contains('url-btn')) { showUrlModal(surveyId, surveyName); return; }
        if (button.classList.contains('edit-btn')) {
            const spinner = showAdminSpinner();
            try {
                const questions = await fetchApiData({ action: 'getQuestions', sheet: surveyId });
                if (questions.error) {
                    showAlert(questions.error);
                    return;
                }
                renderAddOrEditSurveyForm({ name: listItem.dataset.name, id: surveyId, questions: questions });
            } catch (error) {
                showAlert(`Failed to load questions: ${error.message}`);
            } finally {
                hideAdminSpinner(spinner);
            }
        } else if (button.classList.contains('delete-btn')) {
    if (confirm(`Are you sure you want to delete the survey "${listItem.dataset.name}"? This action cannot be undone.`)) {
        const spinner = showAdminSpinner();

        const handleSuccess = () => {
            hideAdminSpinner(spinner);
            showAlert('Survey deleted successfully.');
            if (adminDataCache && adminDataCache.surveyNames) {
                adminDataCache.surveyNames = adminDataCache.surveyNames.filter(s => s.id !== surveyId);
            }
            renderSurveyList('edit');
            refreshDataInBackground();
        };

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'deleteSurvey', sheetId: surveyId }),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }
        })
        .then(res => res.json())
        .then(result => {
            if (result && result.status === 'success') {
                handleSuccess();
            } else {
                hideAdminSpinner(spinner);
                showAlert('Error deleting survey: ' + (result ? result.message : 'Unknown error'));
            }
        })
        .catch(err => {
            if (err instanceof TypeError && err.message === 'Failed to fetch') {
                handleSuccess();
            } else {
                hideAdminSpinner(spinner);
                showAlert('An unexpected error occurred: ' + err.message);
            }
        });
    }
}
    });
}

    function showUrlModal(surveyId, surveyName) {
        const existingModal = document.querySelector('.url-modal-overlay');
        if (existingModal) existingModal.remove();

        let linksHtml = '';
        const baseUrl = `${window.location.origin}${window.location.pathname}`;
        
        Object.keys(themes).forEach(companyKey => {
            const theme = themes[companyKey];
            const link = `${baseUrl}?s=${surveyId}&c=${encodeURIComponent(companyKey)}-${theme.code}`;
            linksHtml += `
                <div class="link-entry">
                    <span class="company-name">${companyKey}:</span>
                    <input type="text" class="link-text-input" value="${link}" readonly>
                    <div class="link-actions">
                        <button class="copy-link-btn" data-link="${link}" title="Copy Link">
                            <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20" fill="currentColor"><path d="M360-240q-33 0-56.5-23.5T280-320v-480q0-33 23.5-56.5T360-880h360q33 0 56.5 23.5T800-800v480q0 33-23.5 56.5T720-240H360Zm0-80h360v-480H360v480ZM200-80q-33 0-56.5-23.5T120-160v-560h80v560h440v80H200Zm160-240v-480 480Z"/></svg>
                        </button>
                        <button class="go-to-link-btn" data-link="${link}" title="Go to Link">
                           <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20" fill="currentColor"><path d="m256-240-56-56 384-384H240v-80h480v480h-80v-344L256-240Z"/></svg>
                        </button>
                    </div>
                </div>
            `;
        });

        const modal = document.createElement('div');
        modal.className = 'url-modal-overlay';
        modal.innerHTML = `
            <div class="url-modal-content">
                <div class="url-modal-header">
                    <h2>Links for: ${surveyName}</h2>
                    <button class="url-modal-close">&times;</button>
                </div>
                <div class="url-modal-body">
                    ${linksHtml}
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        modal.querySelector('.url-modal-close').addEventListener('click', () => modal.remove());
        modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
        
        modal.querySelectorAll('.copy-link-btn').forEach(btn => {
            btn.addEventListener('click', e => {
                const linkToCopy = e.currentTarget.dataset.link;
                navigator.clipboard.writeText(linkToCopy).then(() => {
                    showAlert('Link copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    showAlert('Failed to copy link.');
                });
            });
        });

        modal.querySelectorAll('.go-to-link-btn').forEach(btn => {
            btn.addEventListener('click', e => {
                const linkToGo = e.currentTarget.dataset.link;
                window.open(linkToGo, '_blank');
            });
        });
    }
      

    const urlParamsForCheck = new URLSearchParams(window.location.search);
    if (urlParamsForCheck.has('access-key')) {
        checkAdminAccess();
    } else {
        initializeSurvey();
    }
});
// This new function uses the modern fetch API, which is more reliable.
async function fetchApiData(params) {
    const url = new URL(SCRIPT_URL);
    for (const key in params) {
        url.searchParams.append(key, params[key]);
    }
    try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`Network response was not ok: ${response.statusText}`);
        }
        return await response.json();
    } catch (error) {
        console.error("Fetch API Error:", error);
        // Re-throw the error to be caught by the calling function
        throw new Error(`Failed to load data for action: ${params.action}. ${error.message}`);
    }
}

async function fetchAllAdminDataInPromise() {
    // We now use our new fetch function and Promise.all for parallel requests
    const [statsData, surveyNames] = await Promise.all([
        fetchApiData({ action: 'getStatisticsData' }),
        fetchApiData({ action: 'getSurveyNames' })
    ]);
    return { statsData, surveyNames };
}

function startBackgroundRefresh() {
    if (cacheIntervalId) {
        clearInterval(cacheIntervalId);
    }
    cacheIntervalId = setInterval(() => {
        refreshDataInBackground();
    }, 10 * 60 * 1000); 
}

function refreshDataInBackground(forceRender = false) {
    fetchAllAdminDataInPromise().then(newData => {
        if (adminDataCache) {
            compareAndNotify(newData, adminDataCache);
        }
        adminDataCache = newData;

        if (forceRender) {
            if (document.querySelector('.admin-list')) {
                renderSurveyList('edit');
            }
        }
    }).catch(error => {
        console.error("Background refresh failed:", error);
    });
}

function compareAndNotify(newData, oldData, notificationType) {
    const changes = [];

    const oldSurveyMap = oldData.surveyNames.reduce((map, survey) => {
        map[survey.id] = survey;
        return map;
    }, {});
    const newSurveyMap = newData.surveyNames.reduce((map, survey) => {
        map[survey.id] = survey;
        return map;
    }, {});

    for (const id in newSurveyMap) {
        const newSurvey = newSurveyMap[id];
        const oldSurvey = oldSurveyMap[id];

        if (!oldSurvey) {
            changes.push(`New survey added: <b>${newSurvey.name}</b>`);
        } else {
            if (newSurvey.name !== oldSurvey.name) {
                changes.push(`Survey '<em>${oldSurvey.name}</em>' was renamed to <b>${newSurvey.name}</b>`);
            } else if (newSurvey.lastModified !== oldSurvey.lastModified) {
                changes.push(`Survey edited: <b>${newSurvey.name}</b>`);
            }
        }
    }

    for (const id in oldSurveyMap) {
        if (!newSurveyMap[id]) {
            changes.push(`Survey deleted: <b>${oldSurveyMap[id].name}</b>`);
        }
    }

    const newResponsesCount = newData.statsData.allParticipants.length;
    const oldResponsesCount = oldData.statsData.allParticipants.length;
    if (newResponsesCount > oldResponsesCount) {
        const diff = newResponsesCount - oldResponsesCount;
        changes.push(`<b>${diff}</b> new survey response(s) submitted.`);
    }

    if (changes.length > 0) {
        if (notificationType === 'welcome') {
            showWelcomeNotificationModal(changes);
        } else {
            showLiveToastNotification(changes);
        }
    }
}
function showWelcomeNotificationModal(messages) {
    const existingModal = document.querySelector('.custom-welcome-modal-overlay');
    if (existingModal) existingModal.remove();

    const listItems = messages.map(msg => `<li>${msg}</li>`).join('');
    
    const modalOverlay = document.createElement('div');
    modalOverlay.className = 'custom-welcome-modal-overlay';
    
    modalOverlay.innerHTML = `
        <div class="custom-welcome-modal-content">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" height="32" viewBox="0 -960 960 960" width="32" fill="currentColor"><path d="M480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm-40-160v-360h80v360h-80Zm40-440q-17 0-28.5-11.5T440-720q0-17 11.5-28.5T480-760q17 0 28.5 11.5T520-720q0 17-11.5 28.5T480-680Z"/></svg>
                What's New?
            </h2>
            <ul>${listItems}</ul>
            <button>CONTINUE</button>
        </div>
    `;
    
    document.body.appendChild(modalOverlay);
    
    const closeButton = modalOverlay.querySelector('button');
    closeButton.addEventListener('click', () => {
        modalOverlay.remove();
    });

    modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) {
            modalOverlay.remove();
        }
    });
}

function showLiveToastNotification(messages) {
    const existingToast = document.querySelector('.live-toast-notification');
    if (existingToast) existingToast.remove();

    const listItems = messages.map(msg => `<li>- ${msg}</li>`).join('');
    const toast = document.createElement('div');
    toast.className = 'live-toast-notification';
    toast.innerHTML = `
        <h4>Updates Found!</h4>
        <ul>${listItems}</ul>
    `;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 10000);
}
</script>
</body>
</html>

